name: Build and Deploy MkDocs Site + PDFs

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: write


jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Install Pandoc 
      # ----------------------------
      - name: Install Pandoc
        run: |
          wget https://github.com/jgm/pandoc/releases/download/3.5/pandoc-3.5-1-amd64.deb
          sudo dpkg -i pandoc-3.5-1-amd64.deb
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-latex-recommended \
                                  texlive-fonts-recommended texlive-fonts-extra

      - name: Copy Pandoc templates
        run: |
          sudo mkdir -p /usr/share/pandoc/data/templates
          sudo cp templates/custom.latex /usr/share/pandoc/data/templates/custom.latex
          sudo cp templates/listings-setup.tex /usr/share/pandoc/data/templates/listings-setup.tex

      # ----------------------------
      # Python / MkDocs
      # ----------------------------
      - name: Install Python and MkDocs dependencies
        run: |
          sudo apt-get install -y python3-pip
          python3 -m pip config set global.break-system-packages true
          pip install mkdocs==1.4.2
          pip install mkdocs-material==9.6.9
          pip install mkdocs-material[extras]
          pip install pymdown-extensions==10.16.1
          pip install markdown-katex==202406.1035
          pip install mkdocs-gen-files==0.5.0
          pip install mkdocs-minify-plugin==0.8.0
          pip install pyyaml==6.0.1
          pip install bs4==0.0.2
          cd $GITHUB_WORKSPACE
          pip install .

      - name: Install PDF utilities
        run: |
          sudo apt-get install -y poppler-utils

      # ----------------------------
      # Build MkDocs
      # ----------------------------
      - name: Build MkDocs site
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -e
          cd $GITHUB_WORKSPACE

          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Branch detected: $BRANCH"

          echo "Patching mkdocs.yml"
          BRANCH="$BRANCH" REPO_NAME="$REPO_NAME" \
            python3 .github/scripts/patch_mkdocs.py

          echo "==== mkdocs.yml content before build ===="
          cat mkdocs.yml
          echo "========================================="

          mkdocs build

      # ----------------------------
      # PDF / DOCX / EPUB
      # ----------------------------
      - name: Conversion PDF / ePUB
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          BOOK_DIR="docs/book"
          CONTENTS="site/download"
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          mkdir -p "$CONTENTS"

          if [ ! -d "$BOOK_DIR" ]; then
              echo "Book directory $BOOK_DIR not found. Skipping PDF build."
              exit 0
          fi

          cd "$BOOK_DIR"
          echo "Processing book"

          md_files=""
          if ls chapter*.md 1>/dev/null 2>&1; then
              for chapter in $(ls chapter*.md | sort -V); do
                  md_files="$md_files $chapter"
              done
          fi

          echo "Combining markdown files: $md_files"
          > combined.md

          for file in $md_files; do
              sed '/^---$/,/^---$/d' "$file" >> combined.md
              echo "" >> combined.md
              echo "\pagebreak" >> combined.md
          done

          echo "Cleaning markdown references"
          python3 ../../.github/scripts/clean_md_links.py combined.md
          sed -i \
            -e 's/<a\s*[^>]*id="\([^"]*\)"[^>]*>/\\label{\1}/g' \
            -e 's/\xC2\xA0/ /g' combined.md

          echo "Sanitizing markdown"
          python3 ../../.github/scripts/sanitize_md.py combined.md

          if [ "$BRANCH" != "main" ]; then
            echo "Generating DOCX"
            pandoc -s --number-sections --listings \
              --metadata-file book-desc.yml \
              --metadata-file pandoc-pdf.yml \
              --output="${REPO_NAME}.docx" combined.md
            cp "${REPO_NAME}.docx" "../../$CONTENTS" || true
          fi

          echo "Generating PDF"
          pandoc -s --number-sections --listings \
            --template "/usr/share/pandoc/data/templates/custom.latex" \
            --metadata-file book-desc.yml \
            --metadata-file pandoc-pdf.yml \
            --output="${REPO_NAME}.pdf" combined.md

          cp "${REPO_NAME}.pdf" "../../$CONTENTS"

          echo "Generating PDF icon"
          pdftoppm -png -f 1 -l 1 -singlefile "${REPO_NAME}.pdf" "../../$CONTENTS/${REPO_NAME}"

          ICON_PNG="../../$CONTENTS/${REPO_NAME}.png"

          if [ -f "$ICON_PNG" ]; then
              python3 ../../.github/scripts/clean_for_epub.py combined.md combined-epub.md
              python3 ../../.github/scripts/epub_numbering.py combined-epub.md

              echo "Generating EPUB"
              pandoc -s \
                --metadata-file book-desc.yml \
                --metadata-file pandoc-epub.yml \
                --epub-cover-image="$ICON_PNG" \
                --output="${REPO_NAME}.epub" combined-epub.md

              cp "${REPO_NAME}.epub" "../../$CONTENTS" || true
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          keep_files: true
          destination_dir: ${{ github.ref_name != 'main' && github.ref_name || '' }}

  # ==========================================================
  # CLEANUP JOB 
  # ==========================================================
  cleanup-previews:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Remove obsolete branch previews
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd gh-pages

          WHITELIST="addon assets books download images search stylesheets"
          ACTIVE_BRANCHES=$(gh api repos/${GITHUB_REPOSITORY}/branches --jq '.[].name')

          for dir in *; do
            [ -d "$dir" ] || continue

            if echo "$WHITELIST" | grep -qw "$dir"; then
              continue
            fi

            if ! echo "$ACTIVE_BRANCHES" | grep -qw "$dir"; then
              echo "Removing obsolete preview: $dir"
              rm -rf "$dir"
            fi
          done

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Cleanup obsolete branch previews" || echo "Nothing to clean"
          git push
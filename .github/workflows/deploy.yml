name: Build and Deploy MkDocs Site + PDFs

on:
  push:
    branches: 
      - main
      - '**'
  workflow_dispatch:

permissions:
  contents: write 

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: |
          wget https://github.com/jgm/pandoc/releases/download/3.5/pandoc-3.5-1-amd64.deb
          sudo dpkg -i pandoc-3.5-1-amd64.deb
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-latex-recommended \
                                  texlive-fonts-recommended texlive-fonts-extra

      - name: Copy Pandoc templates
        run: |
          sudo mkdir -p /usr/share/pandoc/data/templates
          sudo cp templates/custom.latex /usr/share/pandoc/data/templates/custom.latex
          sudo cp templates/listings-setup.tex /usr/share/pandoc/data/templates/listings-setup.tex

      - name: Install Python and MkDocs dependencies
        run: |
          sudo apt-get install -y python3-pip
          python3 -m pip config set global.break-system-packages true
          pip install mkdocs==1.4.2
          pip install mkdocs-material==9.6.9 
          pip install mkdocs-material[extras]
          pip install pymdown-extensions==10.16.1
          pip install markdown-katex==202406.1035
          pip install mkdocs-gen-files==0.5.0
          pip install mkdocs-minify-plugin==0.8.0
          pip install pyyaml==6.0.1
          pip install bs4==0.0.2
          cd $GITHUB_WORKSPACE
          pip install . 

      - name: Install PDF utilities
        run: |
          sudo apt-get install -y poppler-utils
          
      - name: Build MkDocs site
        run: |
          cd $GITHUB_WORKSPACE
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
          echo "Branch detected: $BRANCH"

          if [ "$BRANCH" != "main" ]; then

            echo "Patching mkdocs.yml"
            BRANCH=$BRANCH python3 .github/scripts/patch_mkdocs.py

            mkdir -p docs
            echo "# WORK IN PROGRESS
            This is the branch work page **$BRANCH** - click on Your-Book menu" > docs/index.md
          fi

          echo "==== mkdocs.yml content before build ===="
          cat mkdocs.yml
          echo "========================================="

          echo "Building site"
          mkdocs build

      - name: Conversion PDF / ePUB
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -e

          cd "$GITHUB_WORKSPACE"

          BOOK_DIR="docs/book"
          CONTENTS="site/download"
          BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"

          mkdir -p "$CONTENTS"

          if [ ! -d "$BOOK_DIR" ]; then
              echo "Book directory $BOOK_DIR not found. Skipping PDF build."
              exit 0
          fi

          cd "$BOOK_DIR"
          echo "Processing book

          md_files=""
          if ls chapter*.md 1>/dev/null 2>&1; then
              for chapter in $(ls chapter*.md | sort -V); do
                  md_files="$md_files $chapter"
              done
          fi

          echo "Combining markdown files: $md_files"
          cat /dev/null > combined.md
          for file in $md_files; do
              sed '/^---$/,/^---$/d' "$file" >> combined.md
              echo "" >> combined.md
              echo "\pagebreak" >> combined.md
          done

          echo "Cleaning markdown references"
          python3 ../../.github/scripts/clean_md_links.py combined.md
          sed -i \
            -e 's/<a\s*[^>]*id="\([^"]*\)"[^>]*>/\\label{\1}/g' \
            -e 's/\xC2\xA0/ /g' combined.md

          echo "sanitize md files to remove hidden unicode characters"
          python3 ../../.github/scripts/sanitize_md.py combined.md

          if [ "$BRANCH" != "main" ]; then
            echo "Launch DOCX conversion for review"

            pandoc -s --number-sections --listings \
              --metadata-file header.yml \
              --output="${REPO_NAME}.docx" combined.md

            if [ -f "${REPO_NAME}.docx" ]; then
                echo "DOCX generated successfully for ${REPO_NAME}"
                cp "${REPO_NAME}.docx" "$CONTENTS"
            else
                echo "Failed to generate DOCX for ${REPO_NAME}."
            fi
          fi

          echo "Generating PDF"
          pandoc -s --number-sections --listings \
            --template "/usr/share/pandoc/data/templates/custom.latex" \
            --metadata-file header.yml \
            --output="${REPO_NAME}.pdf" combined.md

          if [ ! -f "${REPO_NAME}.pdf" ]; then
              echo "PDF generation failed."
              exit 1
          fi

          cp "${REPO_NAME}.pdf" "../../$CONTENTS/"

          echo "Generating PDF icon"
          pdftoppm -png -f 1 -l 1 -singlefile "${REPO_NAME}.pdf" "../../$CONTENTS/${REPO_NAME}"

          ICON_PNG="../../$CONTENTS/${REPO_NAME}.png"

          if [ -f "$ICON_PNG" ]; then
              echo "Preparing EPUB markdown"
              python3 ../../.github/scripts/clean_for_epub.py combined.md combined-epub.md
              python3 ../../.github/scripts/epub_numbering.py combined-epub.md

              echo "Generating EPUB"
              pandoc -s \
                --metadata-file=header-epub.yml \
                --epub-cover-image="$ICON_PNG" \
                --output="${REPO_NAME}.epub" combined-epub.md

              if [ -f "${REPO_NAME}.epub" ]; then
                  cp "${REPO_NAME}.epub" "../../$CONTENTS/"
              else
                  echo "EPUB generation failed."
              fi
          else
              echo "Icon generation failed, skipping EPUB."
          fi

      - name: List site output
        run: ls -R ./site

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./site
          keep_files: true
          destination_dir: ${{ github.ref_name != 'main' && github.ref_name || '' }}

      - name: Clean up old branch previews
        if: github.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          PAGES_ROOT=./site  # root of gh-pages content
          # Directories to never remove (main site folders)
          WHITELIST="addon assets books download images search stylesheets"

          echo "Fetching list of active branches..."
          ACTIVE_BRANCHES=$(gh api repos/${GITHUB_REPOSITORY}/branches --jq '.[].name')

          echo "Active branches:"
          echo "$ACTIVE_BRANCHES"

          echo "Scanning deployed branch previews..."
          for dir in "$PAGES_ROOT"/*; do
            if [ -d "$dir" ]; then
              branch_name=$(basename "$dir")

              # Skip whitelisted folders
              if echo "$WHITELIST" | grep -qw "$branch_name"; then
                echo "Skipping main site folder: $branch_name"
                continue
              fi

              # Check if the branch is active
              if ! echo "$ACTIVE_BRANCHES" | grep -qw "$branch_name"; then
                echo "Removing obsolete preview folder: $branch_name"
                rm -rf "$dir"
              else
                echo "Keeping active branch folder: $branch_name"
              fi
            fi
          done

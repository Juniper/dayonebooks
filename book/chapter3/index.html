<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="HPE Juniper TME Team"><link href=../chapter2/ rel=prev><link href=../../about/ rel=next><link rel=icon href=../../images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.9"><title>FBF use Case 2 - Day One books - A technical eBook collection by HPE Juniper Networking</title><link rel=stylesheet href=../../assets/stylesheets/main.4af4bdda.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CNova:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Google Sans";--md-code-font:"Nova"}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#case-2---fbf-using-forwarding-instance class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Day One books - A technical eBook collection by HPE Juniper Networking" class="md-header__button md-logo" aria-label="Day One books - A technical eBook collection by HPE Juniper Networking" data-md-component=logo> <img src=../../images/favicon.ico alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Day One books - A technical eBook collection by HPE Juniper Networking </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> FBF use Case 2 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../chapter1/ class=md-tabs__link> The Book </a> </li> <li class=md-tabs__item> <a href=../../about/ class=md-tabs__link> About us </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Day One books - A technical eBook collection by HPE Juniper Networking" class="md-nav__button md-logo" aria-label="Day One books - A technical eBook collection by HPE Juniper Networking" data-md-component=logo> <img src=../../images/favicon.ico alt=logo> </a> Day One books - A technical eBook collection by HPE Juniper Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> The Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> The Book </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> The Sample Day One Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> The Sample Day One Book </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter1/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../chapter2/ class=md-nav__link> <span class=md-ellipsis> FBF Use Case 1 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> FBF use Case 2 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> FBF use Case 2 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#rib-group-concept class=md-nav__link> <span class=md-ellipsis> 1.1. rib-group Concept </span> </a> </li> <li class=md-nav__item> <a href=#example-2---topology class=md-nav__link> <span class=md-ellipsis> 1.2. Example 2 - Topology </span> </a> </li> <li class=md-nav__item> <a href=#pfe-analysis class=md-nav__link> <span class=md-ellipsis> 1.3. PFE analysis </span> </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> 1.4. Conclusion </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../about/ class=md-nav__link> <span class=md-ellipsis> About us </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#rib-group-concept class=md-nav__link> <span class=md-ellipsis> 1.1. rib-group Concept </span> </a> </li> <li class=md-nav__item> <a href=#example-2---topology class=md-nav__link> <span class=md-ellipsis> 1.2. Example 2 - Topology </span> </a> </li> <li class=md-nav__item> <a href=#pfe-analysis class=md-nav__link> <span class=md-ellipsis> 1.3. PFE analysis </span> </a> </li> <li class=md-nav__item> <a href=#conclusion class=md-nav__link> <span class=md-ellipsis> 1.4. Conclusion </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=case-2---fbf-using-forwarding-instance>1. Case 2 - FBF Using forwarding instance<a class=headerlink href=#case-2---fbf-using-forwarding-instance title="Permanent link">¶</a></h1> <p>The second approach to achieving Filter-Based Forwarding (FBF) leverages the <strong>forwarding-type routing instance</strong>. In this method, the FBF filter term action redirects traffic to a specific routing instance of type <code>forwarding</code>.</p> <p>This solution is considered the legacy approach and is widely supported on MX platforms. Compared to Case 1, it requires a deeper understanding of the <strong><code>rib-group</code></strong> concept. The following section will elucidate the necessary concepts to effectively implement FBF using this method.</p> <h2 id=rib-group-concept>1.1. rib-group Concept<a class=headerlink href=#rib-group-concept title="Permanent link">¶</a></h2> <p>A <strong>RIB group</strong> on Juniper devices enables routes learned in one routing table (the <em>source</em> or <em>initial</em> RIB) to be simultaneously installed into multiple routing tables (the <em>destination</em> RIBs). This feature is commonly utilized to share routes between routing instances (VRFs) or between the global routing table and a VRF. Policies can control which routes are imported, making RIB groups a flexible method for internal route redistribution without relying on BGP or other protocols.</p> <p>Without a RIB group, each protocol — depending on the address family — feeds routes into a default routing table. In the context of RIB groups, this default table is referred to as the <em>source</em> or <em>initial</em> RIB. Similarly, protocols fetch routes (for a given family) from this default table when exporting routes.</p> <p>The figure below illustrates the default routing behavior:</p> <p><figure><img alt="Default routing table management" src=../images/diag4.png><figcaption>Figure 1: Default routing table management</figcaption></figure></p> <p>As shown above, for BGP with the <code>inet</code> family (IPv4 unicast), the default routing table in the global context is <strong><code>inet.0</code></strong> — both for importing and exporting routes. Similarly, interface IPv4 addresses (direct routes) in the global context also reside in <strong><code>inet.0</code></strong>.</p> <p>To leak routes from one table to another, the <strong>RIB group</strong> feature is employed, configured under <strong><code>routing-options</code></strong>. A RIB group is defined with the following parameters:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1>1</a></span>
<span class=normal><a href=#__codelineno-0-2>2</a></span>
<span class=normal><a href=#__codelineno-0-3>3</a></span>
<span class=normal><a href=#__codelineno-0-4>4</a></span>
<span class=normal><a href=#__codelineno-0-5>5</a></span>
<span class=normal><a href=#__codelineno-0-6>6</a></span>
<span class=normal><a href=#__codelineno-0-7>7</a></span>
<span class=normal><a href=#__codelineno-0-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a>[edit routing-options]
<a id=__codelineno-0-2 name=__codelineno-0-2></a>rib-groups {
<a id=__codelineno-0-3 name=__codelineno-0-3></a>    &lt;rib-group-name&gt; {
<a id=__codelineno-0-4 name=__codelineno-0-4></a>        import-rib [ &lt;source_table&gt; &lt;destination_table_1&gt; &lt;destination_table_2&gt; ... ];
<a id=__codelineno-0-5 name=__codelineno-0-5></a>        import-policy &lt;rib-group-import-policy&gt;;
<a id=__codelineno-0-6 name=__codelineno-0-6></a>        export-policy &lt;rib-group-export-policy&gt;;
<a id=__codelineno-0-7 name=__codelineno-0-7></a>    }
<a id=__codelineno-0-8 name=__codelineno-0-8></a>}
</code></pre></div></td></tr></table></div> <blockquote> <p><strong>Note:</strong> <code>import-policy</code> and <code>export-policy</code> are optional, but at least one destination table must be specified in <code>import-rib</code>.</p> </blockquote> <p>The <strong><code>import-rib</code></strong> statement is crucial. The order of tables matters: the first table is the <em>source</em> (or <em>initial</em>, <em>standard</em>, <em>contributing</em>) table. This is the default RIB associated with a given protocol/family combination. With a RIB group, routes are taken from this <em>source</em> table and replicated into one or more <em>destination</em> tables.</p> <p>The RIB group establishes a link between the source RIB and the destination RIBs. The <strong><code>import-policy</code></strong> provides fine-grained control, allowing only specific routes or protocols to be leaked to the destination tables. Similarly, <strong><code>export-policy</code></strong> controls which routes from the destination tables are eligible for export by routing protocols.</p> <p>The next figure illustrates the concept:</p> <p><figure><img alt="Routes leaking thanks to rib-group feature" src=../images/diag5.png><figcaption>Figure 2: Routes leaking thanks to rib-group feature</figcaption></figure></p> <p>This example demonstrates how BGP unicast routes from the global routing context are leaked into a new routing table (or instance) called <strong>FBF</strong>. While these routes remain in their default (source) table — <strong><code>inet.0</code></strong> — they are also copied into an additional table, in this case, the destination <strong><code>FBF.inet.0</code></strong>, using a RIB group.</p> <p>In the context of Filter-Based Forwarding (FBF), this allows you to constrain routing decisions to a specific set of routes — not by using the standard FIB, but by relying on a custom FIB built from the custom destination RIB. This destination RIB can be selectively populated with only the routes you want to use for FBF-based traffic steering.</p> <p>Let's illustrate this second FBF method with an example.</p> <h2 id=example-2---topology>1.2. Example 2 - Topology<a class=headerlink href=#example-2---topology title="Permanent link">¶</a></h2> <p>The Device Under Test (<strong>DUT</strong>) is an <strong>MX480</strong> equipped with an <strong>MPC10E</strong> line card.</p> <p>This simplified setup represents a typical <strong>DCI</strong> router connected to an <strong>IP Fabric</strong>, providing access to remote resources via two distinct paths:</p> <ul> <li>A <strong>quality</strong> path through an <strong>MPLS/SR</strong> core network, and</li> <li>A <strong>best-effort</strong> path via a <strong>direct peering or transit (PNI)</strong> connection.</li> </ul> <p>In this scenario, remote resources are reached via the direct PNI link connected in the Global Routing Table (GRT) and sent from the peer to our DUT via an eBGP session. The DUT also receives the same remote resources from a remote <strong>ASBR</strong> through an iBGP session. The remote ASBR sets the next-hop address of these routes with its Segment Routing node-SID (advertised in the ISIS SR domain). This allows for a BGP Free-core by tunneling traffic in a transport SR tunnel.</p> <p><figure><img alt="Network topology" src=../images/diag3.png><figcaption>Figure 3: Network topology</figcaption></figure></p> <p>For demonstration purposes, the remote resource is simulated using the public prefix <strong>8.8.8.0/24</strong>. This prefix is preferred by default via the direct PNI, with a backup path available through the MPLS/SR core (shortcut SR):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1> 1</a></span>
<span class=normal><a href=#__codelineno-1-2> 2</a></span>
<span class=normal><a href=#__codelineno-1-3> 3</a></span>
<span class=normal><a href=#__codelineno-1-4> 4</a></span>
<span class=normal><a href=#__codelineno-1-5> 5</a></span>
<span class=normal><a href=#__codelineno-1-6> 6</a></span>
<span class=normal><a href=#__codelineno-1-7> 7</a></span>
<span class=normal><a href=#__codelineno-1-8> 8</a></span>
<span class=normal><a href=#__codelineno-1-9> 9</a></span>
<span class=normal><a href=#__codelineno-1-10>10</a></span>
<span class=normal><a href=#__codelineno-1-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a>regress@rtme-mx-62&gt; show route 8.8.8.0/24 
<a id=__codelineno-1-2 name=__codelineno-1-2></a>
<a id=__codelineno-1-3 name=__codelineno-1-3></a>inet.0: 43 destinations, 44 routes (43 active, 0 holddown, 0 hidden)
<a id=__codelineno-1-4 name=__codelineno-1-4></a>+ = Active Route, - = Last Active, * = Both
<a id=__codelineno-1-5 name=__codelineno-1-5></a>
<a id=__codelineno-1-6 name=__codelineno-1-6></a>8.8.8.0/24         *[BGP/170] 6d 17:31:10, localpref 10000
<a id=__codelineno-1-7 name=__codelineno-1-7></a>                      AS path: 1234 6000 I, validation-state: unverified
<a id=__codelineno-1-8 name=__codelineno-1-8></a>                    &gt;  to 172.16.8.1 via et-2/0/0.0                       &lt;&lt;&lt; PNI
<a id=__codelineno-1-9 name=__codelineno-1-9></a>                    [BGP/170] 00:00:11, localpref 50, from 193.252.102.2
<a id=__codelineno-1-10 name=__codelineno-1-10></a>                      AS path: I, validation-state: unverified
<a id=__codelineno-1-11 name=__codelineno-1-11></a>                    &gt;  to 172.16.1.1 via et-5/0/0.0, Push 20002           &lt;&lt;&lt; SR Tunnel 
</code></pre></div></td></tr></table></div> <p><strong>Initial Configuration</strong></p> <p>Below is the initial configuration for the DUT, kept simple for clarity:</p> <ul> <li>The DUT receives customer prefixes via <strong>eBGP</strong> from the peer group <strong>FABRIC</strong>.</li> <li>The DUT receives public prefixes from the PNI peer—this is the primary/best path. A higher local-preference is set using the <code>PREF</code> import policy.</li> <li>It also receives public prefixes from the peer ASBR via <strong>iBGP</strong>—this is a backup path—remotely reachable through an MPLS SR Tunnel.</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1> 1</a></span>
<span class=normal><a href=#__codelineno-2-2> 2</a></span>
<span class=normal><a href=#__codelineno-2-3> 3</a></span>
<span class=normal><a href=#__codelineno-2-4> 4</a></span>
<span class=normal><a href=#__codelineno-2-5> 5</a></span>
<span class=normal><a href=#__codelineno-2-6> 6</a></span>
<span class=normal><a href=#__codelineno-2-7> 7</a></span>
<span class=normal><a href=#__codelineno-2-8> 8</a></span>
<span class=normal><a href=#__codelineno-2-9> 9</a></span>
<span class=normal><a href=#__codelineno-2-10>10</a></span>
<span class=normal><a href=#__codelineno-2-11>11</a></span>
<span class=normal><a href=#__codelineno-2-12>12</a></span>
<span class=normal><a href=#__codelineno-2-13>13</a></span>
<span class=normal><a href=#__codelineno-2-14>14</a></span>
<span class=normal><a href=#__codelineno-2-15>15</a></span>
<span class=normal><a href=#__codelineno-2-16>16</a></span>
<span class=normal><a href=#__codelineno-2-17>17</a></span>
<span class=normal><a href=#__codelineno-2-18>18</a></span>
<span class=normal><a href=#__codelineno-2-19>19</a></span>
<span class=normal><a href=#__codelineno-2-20>20</a></span>
<span class=normal><a href=#__codelineno-2-21>21</a></span>
<span class=normal><a href=#__codelineno-2-22>22</a></span>
<span class=normal><a href=#__codelineno-2-23>23</a></span>
<span class=normal><a href=#__codelineno-2-24>24</a></span>
<span class=normal><a href=#__codelineno-2-25>25</a></span>
<span class=normal><a href=#__codelineno-2-26>26</a></span>
<span class=normal><a href=#__codelineno-2-27>27</a></span>
<span class=normal><a href=#__codelineno-2-28>28</a></span>
<span class=normal><a href=#__codelineno-2-29>29</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a>regress@rtme-mx-62&gt; show configuration 
<a id=__codelineno-2-2 name=__codelineno-2-2></a>protocols {
<a id=__codelineno-2-3 name=__codelineno-2-3></a>    bgp {
<a id=__codelineno-2-4 name=__codelineno-2-4></a>        group FABRIC {
<a id=__codelineno-2-5 name=__codelineno-2-5></a>            type external;
<a id=__codelineno-2-6 name=__codelineno-2-6></a>            local-address 172.16.0.4;
<a id=__codelineno-2-7 name=__codelineno-2-7></a>            peer-as 5000;
<a id=__codelineno-2-8 name=__codelineno-2-8></a>            neighbor 172.16.0.5;
<a id=__codelineno-2-9 name=__codelineno-2-9></a>        }
<a id=__codelineno-2-10 name=__codelineno-2-10></a>        group PEER {
<a id=__codelineno-2-11 name=__codelineno-2-11></a>            type external;
<a id=__codelineno-2-12 name=__codelineno-2-12></a>            local-address 172.16.8.0;
<a id=__codelineno-2-13 name=__codelineno-2-13></a>            import PREF;
<a id=__codelineno-2-14 name=__codelineno-2-14></a>            family inet {
<a id=__codelineno-2-15 name=__codelineno-2-15></a>                unicast;
<a id=__codelineno-2-16 name=__codelineno-2-16></a>            }
<a id=__codelineno-2-17 name=__codelineno-2-17></a>            peer-as 1234;
<a id=__codelineno-2-18 name=__codelineno-2-18></a>            neighbor 172.16.8.1;
<a id=__codelineno-2-19 name=__codelineno-2-19></a>        }
<a id=__codelineno-2-20 name=__codelineno-2-20></a>        group ASBR {
<a id=__codelineno-2-21 name=__codelineno-2-21></a>            type internal;
<a id=__codelineno-2-22 name=__codelineno-2-22></a>            local-address 193.252.102.101;
<a id=__codelineno-2-23 name=__codelineno-2-23></a>            family inet {
<a id=__codelineno-2-24 name=__codelineno-2-24></a>                unicast;
<a id=__codelineno-2-25 name=__codelineno-2-25></a>            }
<a id=__codelineno-2-26 name=__codelineno-2-26></a>            neighbor 193.252.102.2;
<a id=__codelineno-2-27 name=__codelineno-2-27></a>        }
<a id=__codelineno-2-28 name=__codelineno-2-28></a>    }
<a id=__codelineno-2-29 name=__codelineno-2-29></a>}
</code></pre></div></td></tr></table></div> <p><strong>Configuration of FBF</strong></p> <p>The next steps involve creating a new routing instance (type <code>forwarding</code>) and leaking both the interface routes (i.e., <code>direct</code> routes for resolving the Layer 2 header) and the remote resources (in our case, 8.8.8.0/24), but only those announced by the core network - not those learned via the PNI.</p> <p>First, create the FBF routing instance:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1> 1</a></span>
<span class=normal><a href=#__codelineno-3-2> 2</a></span>
<span class=normal><a href=#__codelineno-3-3> 3</a></span>
<span class=normal><a href=#__codelineno-3-4> 4</a></span>
<span class=normal><a href=#__codelineno-3-5> 5</a></span>
<span class=normal><a href=#__codelineno-3-6> 6</a></span>
<span class=normal><a href=#__codelineno-3-7> 7</a></span>
<span class=normal><a href=#__codelineno-3-8> 8</a></span>
<span class=normal><a href=#__codelineno-3-9> 9</a></span>
<span class=normal><a href=#__codelineno-3-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a>edit 
<a id=__codelineno-3-2 name=__codelineno-3-2></a>load merge terminal relative
<a id=__codelineno-3-3 name=__codelineno-3-3></a>
<a id=__codelineno-3-4 name=__codelineno-3-4></a>routing-instances {
<a id=__codelineno-3-5 name=__codelineno-3-5></a>    FBF {
<a id=__codelineno-3-6 name=__codelineno-3-6></a>        instance-type forwarding;
<a id=__codelineno-3-7 name=__codelineno-3-7></a>    }
<a id=__codelineno-3-8 name=__codelineno-3-8></a>}
<a id=__codelineno-3-9 name=__codelineno-3-9></a>
<a id=__codelineno-3-10 name=__codelineno-3-10></a>commit comment "add_fbf_ri"
</code></pre></div></td></tr></table></div> <p>Next, create a new <code>rib-group</code> called <strong>RG_FBF</strong>, establishing a relationship between the <code>inet.0</code> table and <code>FBF.inet.0</code>. In other words, a relation between the default IPv4 table and the IPv4 table of our newly created <strong>FBF</strong> routing instance.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1> 1</a></span>
<span class=normal><a href=#__codelineno-4-2> 2</a></span>
<span class=normal><a href=#__codelineno-4-3> 3</a></span>
<span class=normal><a href=#__codelineno-4-4> 4</a></span>
<span class=normal><a href=#__codelineno-4-5> 5</a></span>
<span class=normal><a href=#__codelineno-4-6> 6</a></span>
<span class=normal><a href=#__codelineno-4-7> 7</a></span>
<span class=normal><a href=#__codelineno-4-8> 8</a></span>
<span class=normal><a href=#__codelineno-4-9> 9</a></span>
<span class=normal><a href=#__codelineno-4-10>10</a></span>
<span class=normal><a href=#__codelineno-4-11>11</a></span>
<span class=normal><a href=#__codelineno-4-12>12</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a>edit 
<a id=__codelineno-4-2 name=__codelineno-4-2></a>load merge terminal relative
<a id=__codelineno-4-3 name=__codelineno-4-3></a>
<a id=__codelineno-4-4 name=__codelineno-4-4></a>routing-options {
<a id=__codelineno-4-5 name=__codelineno-4-5></a>    rib-groups {
<a id=__codelineno-4-6 name=__codelineno-4-6></a>        RG_FBF {
<a id=__codelineno-4-7 name=__codelineno-4-7></a>            import-rib [ inet.0 FBF.inet.0 ];
<a id=__codelineno-4-8 name=__codelineno-4-8></a>        }
<a id=__codelineno-4-9 name=__codelineno-4-9></a>    }
<a id=__codelineno-4-10 name=__codelineno-4-10></a>}
<a id=__codelineno-4-11 name=__codelineno-4-11></a>
<a id=__codelineno-4-12 name=__codelineno-4-12></a>commit comment "add_rib-group"
</code></pre></div></td></tr></table></div> <p>Remember, the order inside the <code>import-rib</code> option is important. The first table is considered the source table, and the second one is the destination table. At this point, nothing is leaked between these two tables; this configuration merely establishes the relationship.</p> <p>The first routes to leak are the direct interfaces attached to <code>inet.0</code>. This can be achieved with the following configuration under <code>routing-options</code>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1> 1</a></span>
<span class=normal><a href=#__codelineno-5-2> 2</a></span>
<span class=normal><a href=#__codelineno-5-3> 3</a></span>
<span class=normal><a href=#__codelineno-5-4> 4</a></span>
<span class=normal><a href=#__codelineno-5-5> 5</a></span>
<span class=normal><a href=#__codelineno-5-6> 6</a></span>
<span class=normal><a href=#__codelineno-5-7> 7</a></span>
<span class=normal><a href=#__codelineno-5-8> 8</a></span>
<span class=normal><a href=#__codelineno-5-9> 9</a></span>
<span class=normal><a href=#__codelineno-5-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a>edit 
<a id=__codelineno-5-2 name=__codelineno-5-2></a>load merge terminal relative
<a id=__codelineno-5-3 name=__codelineno-5-3></a>
<a id=__codelineno-5-4 name=__codelineno-5-4></a>routing-options {
<a id=__codelineno-5-5 name=__codelineno-5-5></a>    interface-routes {
<a id=__codelineno-5-6 name=__codelineno-5-6></a>        rib-group inet RG_FBF;
<a id=__codelineno-5-7 name=__codelineno-5-7></a>    }
<a id=__codelineno-5-8 name=__codelineno-5-8></a>}
<a id=__codelineno-5-9 name=__codelineno-5-9></a>
<a id=__codelineno-5-10 name=__codelineno-5-10></a>commit comment "import-direct"
</code></pre></div></td></tr></table></div> <p>Once committed, you should see <code>direct</code> and <code>local</code> routes in the <code>FBF.inet.0</code> table. Verify with:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1> 1</a></span>
<span class=normal><a href=#__codelineno-6-2> 2</a></span>
<span class=normal><a href=#__codelineno-6-3> 3</a></span>
<span class=normal><a href=#__codelineno-6-4> 4</a></span>
<span class=normal><a href=#__codelineno-6-5> 5</a></span>
<span class=normal><a href=#__codelineno-6-6> 6</a></span>
<span class=normal><a href=#__codelineno-6-7> 7</a></span>
<span class=normal><a href=#__codelineno-6-8> 8</a></span>
<span class=normal><a href=#__codelineno-6-9> 9</a></span>
<span class=normal><a href=#__codelineno-6-10>10</a></span>
<span class=normal><a href=#__codelineno-6-11>11</a></span>
<span class=normal><a href=#__codelineno-6-12>12</a></span>
<span class=normal><a href=#__codelineno-6-13>13</a></span>
<span class=normal><a href=#__codelineno-6-14>14</a></span>
<span class=normal><a href=#__codelineno-6-15>15</a></span>
<span class=normal><a href=#__codelineno-6-16>16</a></span>
<span class=normal><a href=#__codelineno-6-17>17</a></span>
<span class=normal><a href=#__codelineno-6-18>18</a></span>
<span class=normal><a href=#__codelineno-6-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a>regress@rtme-mx-62&gt; show route table FBF.inet.0 
<a id=__codelineno-6-2 name=__codelineno-6-2></a>
<a id=__codelineno-6-3 name=__codelineno-6-3></a>FBF.inet.0: 10 destinations, 10 routes (10 active, 0 holddown, 0 hidden)
<a id=__codelineno-6-4 name=__codelineno-6-4></a>+ = Active Route, - = Last Active, * = Both
<a id=__codelineno-6-5 name=__codelineno-6-5></a>
<a id=__codelineno-6-6 name=__codelineno-6-6></a>172.16.0.4/31      *[Direct/0] 6d 20:12:58
<a id=__codelineno-6-7 name=__codelineno-6-7></a>                    &gt;  via et-5/2/0.0         &lt;&lt;&lt; Fabric
<a id=__codelineno-6-8 name=__codelineno-6-8></a>172.16.0.4/32      *[Local/0] 00:00:59
<a id=__codelineno-6-9 name=__codelineno-6-9></a>                       Local via et-5/2/0.0
<a id=__codelineno-6-10 name=__codelineno-6-10></a>172.16.1.0/31      *[Direct/0] 6d 20:12:58
<a id=__codelineno-6-11 name=__codelineno-6-11></a>                    &gt;  via et-5/0/0.0         &lt;&lt;&lt; Core
<a id=__codelineno-6-12 name=__codelineno-6-12></a>172.16.1.0/32      *[Local/0] 00:00:59
<a id=__codelineno-6-13 name=__codelineno-6-13></a>                       Local via et-5/0/0.0
<a id=__codelineno-6-14 name=__codelineno-6-14></a>172.16.8.0/31      *[Direct/0] 6d 20:12:58
<a id=__codelineno-6-15 name=__codelineno-6-15></a>                    &gt;  via et-2/0/0.0         &lt;&lt;&lt; PNI
<a id=__codelineno-6-16 name=__codelineno-6-16></a>172.16.8.0/32      *[Local/0] 00:00:59
<a id=__codelineno-6-17 name=__codelineno-6-17></a>                       Local via et-2/0/0.0
<a id=__codelineno-6-18 name=__codelineno-6-18></a>193.252.102.101/32 *[Direct/0] 6d 20:12:58
<a id=__codelineno-6-19 name=__codelineno-6-19></a>                    &gt;  via lo0.0
</code></pre></div></td></tr></table></div> <p>Everything looks good so far. The next step is to leak some BGP routes into the <code>FBF</code> routing table. But which ones?</p> <p>Our goal is to redirect traffic entering this forwarding instance along a specific path — the one advertised by our remote ASBR. This route is available in the default <code>inet.0</code> table as a backup path. To achieve this, we'll configure BGP to use the <code>RG_FBF</code> rib-group. This rib-group allows routes normally imported into <code>inet.0</code> to be simultaneously leaked into <code>FBF.inet.0</code>.</p> <p>Let’s apply this on the <code>ASBR</code> peer-group:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1> 1</a></span>
<span class=normal><a href=#__codelineno-7-2> 2</a></span>
<span class=normal><a href=#__codelineno-7-3> 3</a></span>
<span class=normal><a href=#__codelineno-7-4> 4</a></span>
<span class=normal><a href=#__codelineno-7-5> 5</a></span>
<span class=normal><a href=#__codelineno-7-6> 6</a></span>
<span class=normal><a href=#__codelineno-7-7> 7</a></span>
<span class=normal><a href=#__codelineno-7-8> 8</a></span>
<span class=normal><a href=#__codelineno-7-9> 9</a></span>
<span class=normal><a href=#__codelineno-7-10>10</a></span>
<span class=normal><a href=#__codelineno-7-11>11</a></span>
<span class=normal><a href=#__codelineno-7-12>12</a></span>
<span class=normal><a href=#__codelineno-7-13>13</a></span>
<span class=normal><a href=#__codelineno-7-14>14</a></span>
<span class=normal><a href=#__codelineno-7-15>15</a></span>
<span class=normal><a href=#__codelineno-7-16>16</a></span>
<span class=normal><a href=#__codelineno-7-17>17</a></span>
<span class=normal><a href=#__codelineno-7-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a>edit 
<a id=__codelineno-7-2 name=__codelineno-7-2></a>edit protocols
<a id=__codelineno-7-3 name=__codelineno-7-3></a>load merge terminal relative
<a id=__codelineno-7-4 name=__codelineno-7-4></a>
<a id=__codelineno-7-5 name=__codelineno-7-5></a>bgp {
<a id=__codelineno-7-6 name=__codelineno-7-6></a>    group ASBR {
<a id=__codelineno-7-7 name=__codelineno-7-7></a>        type internal;
<a id=__codelineno-7-8 name=__codelineno-7-8></a>        local-address 193.252.102.101;  
<a id=__codelineno-7-9 name=__codelineno-7-9></a>        family inet {
<a id=__codelineno-7-10 name=__codelineno-7-10></a>            unicast {
<a id=__codelineno-7-11 name=__codelineno-7-11></a>                rib-group RG_FBF;    &lt;&lt;&lt; This tells BGP to use the rib-group and specifies where to leak learned routes
<a id=__codelineno-7-12 name=__codelineno-7-12></a>            }
<a id=__codelineno-7-13 name=__codelineno-7-13></a>        }
<a id=__codelineno-7-14 name=__codelineno-7-14></a>        neighbor 193.252.102.2;
<a id=__codelineno-7-15 name=__codelineno-7-15></a>    }
<a id=__codelineno-7-16 name=__codelineno-7-16></a>}
<a id=__codelineno-7-17 name=__codelineno-7-17></a>
<a id=__codelineno-7-18 name=__codelineno-7-18></a>commit comment "import_bgp"
</code></pre></div></td></tr></table></div> <p>With this configuration, all routes received from this peer-group will be leaked into <code>FBF.inet.0</code>. However, for demonstration purposes, we’ll restrict the leaking to a specific BGP prefix: <strong>8.8.8.0/24</strong>.</p> <p>To do that, we’ll use the <code>import-policy</code> feature of the rib-group. First, we define a policy to authorize leaking from <code>inet.0</code> to <code>FBF.inet.0</code>, but only for:</p> <ul> <li>direct routes, and</li> <li>the BGP prefix 8.8.8.0/24</li> </ul> <p>Here’s the policy definition, followed by its application to the <code>RG_FBF</code> rib-group:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span>
<span class=normal><a href=#__codelineno-8-11>11</a></span>
<span class=normal><a href=#__codelineno-8-12>12</a></span>
<span class=normal><a href=#__codelineno-8-13>13</a></span>
<span class=normal><a href=#__codelineno-8-14>14</a></span>
<span class=normal><a href=#__codelineno-8-15>15</a></span>
<span class=normal><a href=#__codelineno-8-16>16</a></span>
<span class=normal><a href=#__codelineno-8-17>17</a></span>
<span class=normal><a href=#__codelineno-8-18>18</a></span>
<span class=normal><a href=#__codelineno-8-19>19</a></span>
<span class=normal><a href=#__codelineno-8-20>20</a></span>
<span class=normal><a href=#__codelineno-8-21>21</a></span>
<span class=normal><a href=#__codelineno-8-22>22</a></span>
<span class=normal><a href=#__codelineno-8-23>23</a></span>
<span class=normal><a href=#__codelineno-8-24>24</a></span>
<span class=normal><a href=#__codelineno-8-25>25</a></span>
<span class=normal><a href=#__codelineno-8-26>26</a></span>
<span class=normal><a href=#__codelineno-8-27>27</a></span>
<span class=normal><a href=#__codelineno-8-28>28</a></span>
<span class=normal><a href=#__codelineno-8-29>29</a></span>
<span class=normal><a href=#__codelineno-8-30>30</a></span>
<span class=normal><a href=#__codelineno-8-31>31</a></span>
<span class=normal><a href=#__codelineno-8-32>32</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a>edit 
<a id=__codelineno-8-2 name=__codelineno-8-2></a>load merge terminal relative
<a id=__codelineno-8-3 name=__codelineno-8-3></a>
<a id=__codelineno-8-4 name=__codelineno-8-4></a>policy-options {
<a id=__codelineno-8-5 name=__codelineno-8-5></a>    policy-statement FBF_POLICY {
<a id=__codelineno-8-6 name=__codelineno-8-6></a>        term LEAK_DIRECT {
<a id=__codelineno-8-7 name=__codelineno-8-7></a>            from protocol direct;
<a id=__codelineno-8-8 name=__codelineno-8-8></a>            then accept;
<a id=__codelineno-8-9 name=__codelineno-8-9></a>        }
<a id=__codelineno-8-10 name=__codelineno-8-10></a>        term LEAK_BGP {
<a id=__codelineno-8-11 name=__codelineno-8-11></a>            from {
<a id=__codelineno-8-12 name=__codelineno-8-12></a>                protocol bgp;
<a id=__codelineno-8-13 name=__codelineno-8-13></a>                route-filter 8.8.8.0/24 orlonger;
<a id=__codelineno-8-14 name=__codelineno-8-14></a>            }
<a id=__codelineno-8-15 name=__codelineno-8-15></a>            then accept;
<a id=__codelineno-8-16 name=__codelineno-8-16></a>        }
<a id=__codelineno-8-17 name=__codelineno-8-17></a>        term REJECT_OTHER {
<a id=__codelineno-8-18 name=__codelineno-8-18></a>            then reject;
<a id=__codelineno-8-19 name=__codelineno-8-19></a>        }
<a id=__codelineno-8-20 name=__codelineno-8-20></a>    }
<a id=__codelineno-8-21 name=__codelineno-8-21></a>}
<a id=__codelineno-8-22 name=__codelineno-8-22></a>
<a id=__codelineno-8-23 name=__codelineno-8-23></a>routing-options {
<a id=__codelineno-8-24 name=__codelineno-8-24></a>    rib-groups {
<a id=__codelineno-8-25 name=__codelineno-8-25></a>        RG_FBF {
<a id=__codelineno-8-26 name=__codelineno-8-26></a>            import-rib [ inet.0 FBF.inet.0 ];
<a id=__codelineno-8-27 name=__codelineno-8-27></a>            import-policy FBF_POLICY;         &lt;&lt;&lt; controls which routes get leaked
<a id=__codelineno-8-28 name=__codelineno-8-28></a>        }
<a id=__codelineno-8-29 name=__codelineno-8-29></a>    }
<a id=__codelineno-8-30 name=__codelineno-8-30></a>}
<a id=__codelineno-8-31 name=__codelineno-8-31></a>
<a id=__codelineno-8-32 name=__codelineno-8-32></a>commit comment "add_leaking_policy"
</code></pre></div></td></tr></table></div> <p>After committing, you can verify the result with:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1>1</a></span>
<span class=normal><a href=#__codelineno-9-2>2</a></span>
<span class=normal><a href=#__codelineno-9-3>3</a></span>
<span class=normal><a href=#__codelineno-9-4>4</a></span>
<span class=normal><a href=#__codelineno-9-5>5</a></span>
<span class=normal><a href=#__codelineno-9-6>6</a></span>
<span class=normal><a href=#__codelineno-9-7>7</a></span>
<span class=normal><a href=#__codelineno-9-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a>regress@rtme-mx-62&gt; show route table FBF.inet.0 protocol bgp   
<a id=__codelineno-9-2 name=__codelineno-9-2></a>
<a id=__codelineno-9-3 name=__codelineno-9-3></a>FBF.inet.0: 7 destinations, 7 routes (7 active, 0 holddown, 0 hidden)
<a id=__codelineno-9-4 name=__codelineno-9-4></a>+ = Active Route, - = Last Active, * = Both
<a id=__codelineno-9-5 name=__codelineno-9-5></a>
<a id=__codelineno-9-6 name=__codelineno-9-6></a>8.8.8.0/24         *[BGP/170] 01:16:31, localpref 50, from 193.252.102.2
<a id=__codelineno-9-7 name=__codelineno-9-7></a>                      AS path: I, validation-state: unverified
<a id=__codelineno-9-8 name=__codelineno-9-8></a>                    &gt;  to 172.16.1.1 via et-5/0/0.0, Push 20002
</code></pre></div></td></tr></table></div> <p>Perfect — only the 8.8.8.0/24 prefix received from the internal ASBR is installed. The primary route via the PNI isn't present in this instance and remains solely in the <code>inet.0</code> table.</p> <p>Now, to actually redirect the traffic, we’ll use a simple firewall filter. It will match traffic sourced from Customer B and redirect it to the <code>FBF</code> routing instance. This filter is applied to the physical interface connected to the IP Fabric:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span>
<span class=normal><a href=#__codelineno-10-22>22</a></span>
<span class=normal><a href=#__codelineno-10-23>23</a></span>
<span class=normal><a href=#__codelineno-10-24>24</a></span>
<span class=normal><a href=#__codelineno-10-25>25</a></span>
<span class=normal><a href=#__codelineno-10-26>26</a></span>
<span class=normal><a href=#__codelineno-10-27>27</a></span>
<span class=normal><a href=#__codelineno-10-28>28</a></span>
<span class=normal><a href=#__codelineno-10-29>29</a></span>
<span class=normal><a href=#__codelineno-10-30>30</a></span>
<span class=normal><a href=#__codelineno-10-31>31</a></span>
<span class=normal><a href=#__codelineno-10-32>32</a></span>
<span class=normal><a href=#__codelineno-10-33>33</a></span>
<span class=normal><a href=#__codelineno-10-34>34</a></span>
<span class=normal><a href=#__codelineno-10-35>35</a></span>
<span class=normal><a href=#__codelineno-10-36>36</a></span>
<span class=normal><a href=#__codelineno-10-37>37</a></span>
<span class=normal><a href=#__codelineno-10-38>38</a></span>
<span class=normal><a href=#__codelineno-10-39>39</a></span>
<span class=normal><a href=#__codelineno-10-40>40</a></span>
<span class=normal><a href=#__codelineno-10-41>41</a></span>
<span class=normal><a href=#__codelineno-10-42>42</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a>edit 
<a id=__codelineno-10-2 name=__codelineno-10-2></a>load merge terminal relative
<a id=__codelineno-10-3 name=__codelineno-10-3></a>
<a id=__codelineno-10-4 name=__codelineno-10-4></a>firewall {
<a id=__codelineno-10-5 name=__codelineno-10-5></a>    family inet {                       
<a id=__codelineno-10-6 name=__codelineno-10-6></a>        filter FBF_FWD {
<a id=__codelineno-10-7 name=__codelineno-10-7></a>            term CUSTOMER_B {
<a id=__codelineno-10-8 name=__codelineno-10-8></a>                from {
<a id=__codelineno-10-9 name=__codelineno-10-9></a>                    source-address {
<a id=__codelineno-10-10 name=__codelineno-10-10></a>                        172.222.0.0/24;
<a id=__codelineno-10-11 name=__codelineno-10-11></a>                    }
<a id=__codelineno-10-12 name=__codelineno-10-12></a>                }
<a id=__codelineno-10-13 name=__codelineno-10-13></a>                then {
<a id=__codelineno-10-14 name=__codelineno-10-14></a>                    count FBF;
<a id=__codelineno-10-15 name=__codelineno-10-15></a>                    routing-instance FBF;
<a id=__codelineno-10-16 name=__codelineno-10-16></a>                }
<a id=__codelineno-10-17 name=__codelineno-10-17></a>            }
<a id=__codelineno-10-18 name=__codelineno-10-18></a>            term other {
<a id=__codelineno-10-19 name=__codelineno-10-19></a>                then {
<a id=__codelineno-10-20 name=__codelineno-10-20></a>                    count OTHER;
<a id=__codelineno-10-21 name=__codelineno-10-21></a>                    accept;
<a id=__codelineno-10-22 name=__codelineno-10-22></a>                }
<a id=__codelineno-10-23 name=__codelineno-10-23></a>            }
<a id=__codelineno-10-24 name=__codelineno-10-24></a>        }
<a id=__codelineno-10-25 name=__codelineno-10-25></a>    }
<a id=__codelineno-10-26 name=__codelineno-10-26></a>}
<a id=__codelineno-10-27 name=__codelineno-10-27></a>
<a id=__codelineno-10-28 name=__codelineno-10-28></a>interfaces {
<a id=__codelineno-10-29 name=__codelineno-10-29></a>    et-5/2/0 {
<a id=__codelineno-10-30 name=__codelineno-10-30></a>        mtu 9200;
<a id=__codelineno-10-31 name=__codelineno-10-31></a>        unit 0 {
<a id=__codelineno-10-32 name=__codelineno-10-32></a>            family inet {
<a id=__codelineno-10-33 name=__codelineno-10-33></a>                filter {
<a id=__codelineno-10-34 name=__codelineno-10-34></a>                    input FBF_FWD;
<a id=__codelineno-10-35 name=__codelineno-10-35></a>                }
<a id=__codelineno-10-36 name=__codelineno-10-36></a>                address 172.16.0.4/31;
<a id=__codelineno-10-37 name=__codelineno-10-37></a>            }
<a id=__codelineno-10-38 name=__codelineno-10-38></a>        }
<a id=__codelineno-10-39 name=__codelineno-10-39></a>    }
<a id=__codelineno-10-40 name=__codelineno-10-40></a>}
<a id=__codelineno-10-41 name=__codelineno-10-41></a>
<a id=__codelineno-10-42 name=__codelineno-10-42></a>commit comment "apply_fbf"
</code></pre></div></td></tr></table></div> <p>At this point, traffic should be redirected as expected:</p> <p><figure><img alt="FBF in action" src=../images/diag6.png><figcaption>Figure 4: FBF in action</figcaption></figure></p> <p>To help distinguish the flows, we've configured traffic rates as follows:</p> <ul> <li><strong>Customer A</strong>: 1000 packets per second (pps)</li> <li><strong>Customer B</strong>: 5000 packets per second (pps)</li> </ul> <p>Let’s monitor the PNI interface. As expected, only Customer A traffic goes through it (1000pps):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1> 1</a></span>
<span class=normal><a href=#__codelineno-11-2> 2</a></span>
<span class=normal><a href=#__codelineno-11-3> 3</a></span>
<span class=normal><a href=#__codelineno-11-4> 4</a></span>
<span class=normal><a href=#__codelineno-11-5> 5</a></span>
<span class=normal><a href=#__codelineno-11-6> 6</a></span>
<span class=normal><a href=#__codelineno-11-7> 7</a></span>
<span class=normal><a href=#__codelineno-11-8> 8</a></span>
<span class=normal><a href=#__codelineno-11-9> 9</a></span>
<span class=normal><a href=#__codelineno-11-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a>regress@rtme-mx-62&gt; monitor interface et-2/0/0.0   
<a id=__codelineno-11-2 name=__codelineno-11-2></a>Interface: et-2/0/0.0, Enabled, Link is Up
<a id=__codelineno-11-3 name=__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4></a>&lt;- truncated output -&gt;
<a id=__codelineno-11-5 name=__codelineno-11-5></a>
<a id=__codelineno-11-6 name=__codelineno-11-6></a>Remote statistics:
<a id=__codelineno-11-7 name=__codelineno-11-7></a>  Input bytes:                 132708516 (0 bps)                           [0]
<a id=__codelineno-11-8 name=__codelineno-11-8></a>  Output bytes:              49128737556 (3921056 bps)                     [0]
<a id=__codelineno-11-9 name=__codelineno-11-9></a>  Input packets:                  270844 (0 pps)                           [0]
<a id=__codelineno-11-10 name=__codelineno-11-10></a>  Output packets:              100262735 (1000 pps)                        [0] &lt;&lt;&lt; Only Customer A traffic
</code></pre></div></td></tr></table></div> <p>Now let’s check the core-facing interface — we can see Customer B’s traffic being redirected via FBF to the ASBR:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1> 1</a></span>
<span class=normal><a href=#__codelineno-12-2> 2</a></span>
<span class=normal><a href=#__codelineno-12-3> 3</a></span>
<span class=normal><a href=#__codelineno-12-4> 4</a></span>
<span class=normal><a href=#__codelineno-12-5> 5</a></span>
<span class=normal><a href=#__codelineno-12-6> 6</a></span>
<span class=normal><a href=#__codelineno-12-7> 7</a></span>
<span class=normal><a href=#__codelineno-12-8> 8</a></span>
<span class=normal><a href=#__codelineno-12-9> 9</a></span>
<span class=normal><a href=#__codelineno-12-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a>regress@rtme-mx-62&gt; monitor interface et-5/0/0.0  
<a id=__codelineno-12-2 name=__codelineno-12-2></a>Interface: et-5/0/0.0, Enabled, Link is Up
<a id=__codelineno-12-3 name=__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4></a>&lt;- truncated output -&gt;
<a id=__codelineno-12-5 name=__codelineno-12-5></a>
<a id=__codelineno-12-6 name=__codelineno-12-6></a>Remote statistics:
<a id=__codelineno-12-7 name=__codelineno-12-7></a>  Input bytes:                 253750639 (584 bps)                         [0]
<a id=__codelineno-12-8 name=__codelineno-12-8></a>  Output bytes:              57241664165 (19600072 bps)                    [0]
<a id=__codelineno-12-9 name=__codelineno-12-9></a>  Input packets:                  533880 (1 pps)                           [0]
<a id=__codelineno-12-10 name=__codelineno-12-10></a>  Output packets:              116839924 (5000 pps)                        [0] &lt;&lt;&lt; the tunneled Customer B traffic 
</code></pre></div></td></tr></table></div> <p>Now, what if the iBGP session to the ASBR drops, or the 8.8.8.0/24 prefix is no longer announced?</p> <p>In that case, the route will vanish from <code>FBF.inet.0</code>, and the default reject route will take over:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span>
<span class=normal><a href=#__codelineno-13-2>2</a></span>
<span class=normal><a href=#__codelineno-13-3>3</a></span>
<span class=normal><a href=#__codelineno-13-4>4</a></span>
<span class=normal><a href=#__codelineno-13-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a>regress@rtme-mx-62&gt; show route forwarding-table destination 0.0.0.0/0 table FBF 
<a id=__codelineno-13-2 name=__codelineno-13-2></a>Routing table: FBF.inet
<a id=__codelineno-13-3 name=__codelineno-13-3></a>Internet:
<a id=__codelineno-13-4 name=__codelineno-13-4></a>Destination        Type RtRef Next hop           Type Index    NhRef Netif
<a id=__codelineno-13-5 name=__codelineno-13-5></a>default            perm     0                    rjct      520     1       &lt;&lt;&lt; default reject route
</code></pre></div></td></tr></table></div> <p>Just like in <strong>Case 1</strong>, traffic to 8.8.8.0/24 will be rejected and punted to the routing engine (RE), which will respond with ICMP Unreachable messages (after being HW-policed to 2k pps).</p> <p>To silently drop such packets instead of punting them, configure a static discard route as the default inside the FBF instance. But what if you want a fallback to the default routing table instead?</p> <p>That’s simple. If fallback forwarding is needed, just configure a default route inside the FBF instance pointing to the <code>inet.0</code> table. If 8.8.8.0/24 disappears, traffic is then forwarded via the primary PNI path through <code>inet.0</code>.</p> <p>Here’s the configuration:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span>
<span class=normal><a href=#__codelineno-14-11>11</a></span>
<span class=normal><a href=#__codelineno-14-12>12</a></span>
<span class=normal><a href=#__codelineno-14-13>13</a></span>
<span class=normal><a href=#__codelineno-14-14>14</a></span>
<span class=normal><a href=#__codelineno-14-15>15</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a>edit 
<a id=__codelineno-14-2 name=__codelineno-14-2></a>load merge terminal relative
<a id=__codelineno-14-3 name=__codelineno-14-3></a>
<a id=__codelineno-14-4 name=__codelineno-14-4></a>routing-instances {
<a id=__codelineno-14-5 name=__codelineno-14-5></a>    FBF {
<a id=__codelineno-14-6 name=__codelineno-14-6></a>        instance-type forwarding;
<a id=__codelineno-14-7 name=__codelineno-14-7></a>        routing-options {
<a id=__codelineno-14-8 name=__codelineno-14-8></a>            static {
<a id=__codelineno-14-9 name=__codelineno-14-9></a>                route 0.0.0.0/0 next-table inet.0; &lt;&lt;&lt; default fallback route
<a id=__codelineno-14-10 name=__codelineno-14-10></a>            }
<a id=__codelineno-14-11 name=__codelineno-14-11></a>        }
<a id=__codelineno-14-12 name=__codelineno-14-12></a>    }
<a id=__codelineno-14-13 name=__codelineno-14-13></a>}
<a id=__codelineno-14-14 name=__codelineno-14-14></a>
<a id=__codelineno-14-15 name=__codelineno-14-15></a>commit comment "add_fallback_route"
</code></pre></div></td></tr></table></div> <h2 id=pfe-analysis>1.3. PFE analysis<a class=headerlink href=#pfe-analysis title="Permanent link">¶</a></h2> <p>Assuming the FBF configuration is active, let’s break down how the firewall filter behaves at the PFE level. Start by listing the filter instances:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1>1</a></span>
<span class=normal><a href=#__codelineno-15-2>2</a></span>
<span class=normal><a href=#__codelineno-15-3>3</a></span>
<span class=normal><a href=#__codelineno-15-4>4</a></span>
<span class=normal><a href=#__codelineno-15-5>5</a></span>
<span class=normal><a href=#__codelineno-15-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a>regress@rtme-mx-62&gt; start shell pfe network fpc5 
<a id=__codelineno-15-2 name=__codelineno-15-2></a>
<a id=__codelineno-15-3 name=__codelineno-15-3></a>root@rtme-mx-62-fpc5:pfe&gt; show firewall instance     
<a id=__codelineno-15-4 name=__codelineno-15-4></a>Name,Index              Instance Key                    InstanceToken           LinkCount
<a id=__codelineno-15-5 name=__codelineno-15-5></a>FBF_FWD,2                       no-next-filter-0                4777            1
<a id=__codelineno-15-6 name=__codelineno-15-6></a>&lt;- truncated output -&gt;
</code></pre></div></td></tr></table></div> <p>Next, pick up the <strong>InstanceToken</strong> and resolve it using the following command:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1> 1</a></span>
<span class=normal><a href=#__codelineno-16-2> 2</a></span>
<span class=normal><a href=#__codelineno-16-3> 3</a></span>
<span class=normal><a href=#__codelineno-16-4> 4</a></span>
<span class=normal><a href=#__codelineno-16-5> 5</a></span>
<span class=normal><a href=#__codelineno-16-6> 6</a></span>
<span class=normal><a href=#__codelineno-16-7> 7</a></span>
<span class=normal><a href=#__codelineno-16-8> 8</a></span>
<span class=normal><a href=#__codelineno-16-9> 9</a></span>
<span class=normal><a href=#__codelineno-16-10>10</a></span>
<span class=normal><a href=#__codelineno-16-11>11</a></span>
<span class=normal><a href=#__codelineno-16-12>12</a></span>
<span class=normal><a href=#__codelineno-16-13>13</a></span>
<span class=normal><a href=#__codelineno-16-14>14</a></span>
<span class=normal><a href=#__codelineno-16-15>15</a></span>
<span class=normal><a href=#__codelineno-16-16>16</a></span>
<span class=normal><a href=#__codelineno-16-17>17</a></span>
<span class=normal><a href=#__codelineno-16-18>18</a></span>
<span class=normal><a href=#__codelineno-16-19>19</a></span>
<span class=normal><a href=#__codelineno-16-20>20</a></span>
<span class=normal><a href=#__codelineno-16-21>21</a></span>
<span class=normal><a href=#__codelineno-16-22>22</a></span>
<span class=normal><a href=#__codelineno-16-23>23</a></span>
<span class=normal><a href=#__codelineno-16-24>24</a></span>
<span class=normal><a href=#__codelineno-16-25>25</a></span>
<span class=normal><a href=#__codelineno-16-26>26</a></span>
<span class=normal><a href=#__codelineno-16-27>27</a></span>
<span class=normal><a href=#__codelineno-16-28>28</a></span>
<span class=normal><a href=#__codelineno-16-29>29</a></span>
<span class=normal><a href=#__codelineno-16-30>30</a></span>
<span class=normal><a href=#__codelineno-16-31>31</a></span>
<span class=normal><a href=#__codelineno-16-32>32</a></span>
<span class=normal><a href=#__codelineno-16-33>33</a></span>
<span class=normal><a href=#__codelineno-16-34>34</a></span>
<span class=normal><a href=#__codelineno-16-35>35</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a>root@rtme-mx-62-fpc5:pfe&gt; show sandbox token 4777        
<a id=__codelineno-16-2 name=__codelineno-16-2></a>
<a id=__codelineno-16-3 name=__codelineno-16-3></a>&lt;- truncated output -&gt;
<a id=__codelineno-16-4 name=__codelineno-16-4></a>
<a id=__codelineno-16-5 name=__codelineno-16-5></a>Pfe Inst:0 Hw Instance 1, type:1 op:2 ref 0
<a id=__codelineno-16-6 name=__codelineno-16-6></a>  Counter Base:- 0x5400e8
<a id=__codelineno-16-7 name=__codelineno-16-7></a>  Policer Base:- 0
<a id=__codelineno-16-8 name=__codelineno-16-8></a>  Number of counters : 2 (including PSAs)
<a id=__codelineno-16-9 name=__codelineno-16-9></a>
<a id=__codelineno-16-10 name=__codelineno-16-10></a>term CUSTOMER_B (pfe-inst 0)
<a id=__codelineno-16-11 name=__codelineno-16-11></a>     Start Addr   :- 0x85fc
<a id=__codelineno-16-12 name=__codelineno-16-12></a>     Stop Addr    :- 0x85fe
<a id=__codelineno-16-13 name=__codelineno-16-13></a>     Stop NH      :- 0x680825491812a48c
<a id=__codelineno-16-14 name=__codelineno-16-14></a>         Decoding :- FW_STOP: pdesc:0x104a923 desc:0x4a923
<a id=__codelineno-16-15 name=__codelineno-16-15></a>
<a id=__codelineno-16-16 name=__codelineno-16-16></a>     Action Addr  :- 0x4a923
<a id=__codelineno-16-17 name=__codelineno-16-17></a>     Action NH    :- 0x812a81c00020000
<a id=__codelineno-16-18 name=__codelineno-16-18></a>
<a id=__codelineno-16-19 name=__codelineno-16-19></a>match type: prefix
<a id=__codelineno-16-20 name=__codelineno-16-20></a>  loc: 0x85fc nh: 0x7e3000401e000000
<a id=__codelineno-16-21 name=__codelineno-16-21></a>  FW_4BMATCH: fwop:0 desc:0x803c koffset:396 boffset:0 mask:0x149c00e8 data:0x7fb7
<a id=__codelineno-16-22 name=__codelineno-16-22></a>
<a id=__codelineno-16-23 name=__codelineno-16-23></a>Inst: 0 Action-Type: 134
<a id=__codelineno-16-24 name=__codelineno-16-24></a>        JNH      :- 0x2bfffffd00000300:
<a id=__codelineno-16-25 name=__codelineno-16-25></a>                 CounterNH: Relative Base = 1, Offset = 0x0, nextNH = 0xffffff
<a id=__codelineno-16-26 name=__codelineno-16-26></a>
<a id=__codelineno-16-27 name=__codelineno-16-27></a>Inst: 0 Action-Type: 0
<a id=__codelineno-16-28 name=__codelineno-16-28></a>        JNH      :- 0x23fffffc0000100c:
<a id=__codelineno-16-29 name=__codelineno-16-29></a>                 UcodeNH: Indirect Decode: Indirect, Next = 0xffffff, pnh_id = 0, ,
<a id=__codelineno-16-30 name=__codelineno-16-30></a>
<a id=__codelineno-16-31 name=__codelineno-16-31></a>Inst: 0 Action-Type: 0
<a id=__codelineno-16-32 name=__codelineno-16-32></a>        JNH      :- 0x20129a4c0000000c:
<a id=__codelineno-16-33 name=__codelineno-16-33></a>                 UcodeNH: Indirect Decode: Indirect, Next = 0x4a693, pnh_id = 0, ,
<a id=__codelineno-16-34 name=__codelineno-16-34></a>
<a id=__codelineno-16-35 name=__codelineno-16-35></a>&lt;- truncated output -&gt;
</code></pre></div></td></tr></table></div> <p>Focus on the <strong>Action NH</strong> (line 17) and decode the <strong>JNH</strong> word. As shown, this represents a chain of Next-hops:</p> <blockquote> <p>The parameter <code>inst</code> below refers to the PFE id. </p> </blockquote> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1>1</a></span>
<span class=normal><a href=#__codelineno-17-2>2</a></span>
<span class=normal><a href=#__codelineno-17-3>3</a></span>
<span class=normal><a href=#__codelineno-17-4>4</a></span>
<span class=normal><a href=#__codelineno-17-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x812a81c00020000 inst 2     
<a id=__codelineno-17-2 name=__codelineno-17-2></a>CallNH:desc_ptr:0x4aa07, mode=0, count=0x3
<a id=__codelineno-17-3 name=__codelineno-17-3></a>  0x04aa04  0 : 0x2bfffffd00000300  &lt;&lt;&lt; Action Counter
<a id=__codelineno-17-4 name=__codelineno-17-4></a>  0x04aa05  1 : 0x23fffffc0000100c  &lt;&lt;&lt; dummy action for clearing some internal states
<a id=__codelineno-17-5 name=__codelineno-17-5></a>  0x04aa06  2 : 0x20129a4c0000000c  &lt;&lt;&lt; Action routing-instance FBF 
</code></pre></div></td></tr></table></div> <p>Now let’s analyze the third action by decoding the JNH word <code>0x20129a4c0000000c</code> - <strong>UcodeNH</strong> will execute a micro-code sequence:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1>1</a></span>
<span class=normal><a href=#__codelineno-18-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x20129a4c0000000c inst 2   
<a id=__codelineno-18-2 name=__codelineno-18-2></a>UcodeNH: Indirect Decode: Indirect, Next = 0x4a693, pnh_id = 0, ,
</code></pre></div></td></tr></table></div> <p>This is an indirection to a virtual address found in the <strong>Next</strong> field. To read data at <code>0x4a693</code>, use:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1>1</a></span>
<span class=normal><a href=#__codelineno-19-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh vread vaddr 0x4a693 NH inst 2            
<a id=__codelineno-19-2 name=__codelineno-19-2></a>Addr:Nexthop 0x4a693 Paddr:0x104a693, Data = 0x0812944c00020000
</code></pre></div></td></tr></table></div> <p>This yields two important values:</p> <ul> <li><strong>Paddr</strong> (physical address): <code>0x104a693</code></li> <li><strong>Data</strong> read: <code>0x0812944c00020000</code></li> </ul> <blockquote> <p>Note: to read a physical address, use <code>show pread paddr xxx</code>.</p> </blockquote> <p>Since this is a JNH word, decode it again:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1>1</a></span>
<span class=normal><a href=#__codelineno-20-2>2</a></span>
<span class=normal><a href=#__codelineno-20-3>3</a></span>
<span class=normal><a href=#__codelineno-20-4>4</a></span>
<span class=normal><a href=#__codelineno-20-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x0812944c00020000 inst 2    
<a id=__codelineno-20-2 name=__codelineno-20-2></a>CallNH:desc_ptr:0x4a513, mode=0, count=0x3
<a id=__codelineno-20-3 name=__codelineno-20-3></a>  0x04a510  0 : 0x168c000000000000
<a id=__codelineno-20-4 name=__codelineno-20-4></a>  0x04a511  1 : 0x08129d1c00000000
<a id=__codelineno-20-5 name=__codelineno-20-5></a>  0x04a512  2 : 0x23fffffc00000001  &lt;&lt;&lt; this one will be skipped - related to fabric encap. 
</code></pre></div></td></tr></table></div> <p>Now decode each action (except the third one - out of the scope of this article):</p> <ul> <li>First is a <code>ModifyNH</code> (we modify some bytes of the Local Memory - here we reset en encap len)</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1>1</a></span>
<span class=normal><a href=#__codelineno-21-2>2</a></span>
<span class=normal><a href=#__codelineno-21-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x168c000000000000 inst 2    
<a id=__codelineno-21-2 name=__codelineno-21-2></a>ModifyNH: Subcode=Misc(26)
<a id=__codelineno-21-3 name=__codelineno-21-3></a>(Reset encap len)
</code></pre></div></td></tr></table></div> <ul> <li>Second points to another JNH word <code>0x1810318100200008</code> - This one is a <strong>CallNH</strong> which means execute a list of NH in order (when <code>mode=O</code>):</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1>1</a></span>
<span class=normal><a href=#__codelineno-22-2>2</a></span>
<span class=normal><a href=#__codelineno-22-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x08129d1c00000000 inst 2    
<a id=__codelineno-22-2 name=__codelineno-22-2></a>CallNH:desc_ptr:0x4a747, mode=0, count=0x1
<a id=__codelineno-22-3 name=__codelineno-22-3></a>  0x04a746  0 : 0x1810318100200008
</code></pre></div></td></tr></table></div> <p>Decode the first and single NH in the list, <code>0x1810318100200008</code> to reveal a <strong>KTREE</strong> structure used for route lookup:</p> <blockquote> <p>A <strong>KTREE</strong> is the Juniper implementation of a standard binary structure known as <strong>Patricia Tree</strong></p> </blockquote> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1>1</a></span>
<span class=normal><a href=#__codelineno-23-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x1810318100200008 inst 2    
<a id=__codelineno-23-2 name=__codelineno-23-2></a>KtreeNH: skip=8, sw_token=0, arOffset=0, mode=1, descPtr=0xc60400, key=0x4/0 LookupKey
</code></pre></div></td></tr></table></div> <p>Use additional options to dump the full KTREE:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1>1</a></span>
<span class=normal><a href=#__codelineno-24-2>2</a></span>
<span class=normal><a href=#__codelineno-24-3>3</a></span>
<span class=normal><a href=#__codelineno-24-4>4</a></span>
<span class=normal><a href=#__codelineno-24-5>5</a></span>
<span class=normal><a href=#__codelineno-24-6>6</a></span>
<span class=normal><a href=#__codelineno-24-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x1810318100200008 inst 2 ktree yes dump yes 
<a id=__codelineno-24-2 name=__codelineno-24-2></a>Route                                 Depth   JNH
<a id=__codelineno-24-3 name=__codelineno-24-3></a>------------------------------------  ------  ------------------
<a id=__codelineno-24-4 name=__codelineno-24-4></a>Default                                    0  0x08129df400000000
<a id=__codelineno-24-5 name=__codelineno-24-5></a>00000000/32                                1  0x08129d4000000000
<a id=__codelineno-24-6 name=__codelineno-24-6></a>080808/24                                  1  0x0812a04000000000  &lt;&lt;&lt; 8.8.8.0/24 entry
<a id=__codelineno-24-7 name=__codelineno-24-7></a>&lt;- truncated output -&gt;
</code></pre></div></td></tr></table></div> <p>This KTREE acts as the FIB for our FBF routing-instance. For example, if traffic hits the 8.8.8.0/24 prefix, it’s "redirected" to the action identifed by the JNH word <code>0x0812a04000000000</code> which refers to a list of NH (<strong>CallNH</strong>):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1>1</a></span>
<span class=normal><a href=#__codelineno-25-2>2</a></span>
<span class=normal><a href=#__codelineno-25-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x0812a04000000000 inst 2    
<a id=__codelineno-25-2 name=__codelineno-25-2></a>CallNH:desc_ptr:0x4a810, mode=0, count=0x1
<a id=__codelineno-25-3 name=__codelineno-25-3></a>  0x04a80f  0 : 0x2012a0a40000000c
</code></pre></div></td></tr></table></div> <p>Whose the value <code>0x2012a0a40000000c</code> refers to indirection - <strong>UcodeNH</strong>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1>1</a></span>
<span class=normal><a href=#__codelineno-26-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x2012a0a40000000c inst 2    
<a id=__codelineno-26-2 name=__codelineno-26-2></a>UcodeNH: Indirect Decode: Indirect, Next = 0x4a829, pnh_id = 0, ,
</code></pre></div></td></tr></table></div> <p>To read this NH indirection at the virtual address <code>0x4a829</code>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-1>1</a></span>
<span class=normal><a href=#__codelineno-27-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh vread vaddr 0x4a829 NH inst 2                               
<a id=__codelineno-27-2 name=__codelineno-27-2></a>Addr:Nexthop 0x4a829 Paddr:0x104a829, Data = 0x0812a5fc00000000
</code></pre></div></td></tr></table></div> <p>One mmore time, we decode the JNH word retrieved from the previous virtual memory address - and we find out a new list of NH (<strong>CallNH</strong>):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-28-1>1</a></span>
<span class=normal><a href=#__codelineno-28-2>2</a></span>
<span class=normal><a href=#__codelineno-28-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x0812a5fc00000000 inst 2    
<a id=__codelineno-28-2 name=__codelineno-28-2></a>CallNH:desc_ptr:0x4a97f, mode=0, count=0x1
<a id=__codelineno-28-3 name=__codelineno-28-3></a>  0x04a97e  0 : 0x11c0000000038d14
</code></pre></div></td></tr></table></div> <p>And decode <code>0x11c0000000038d14</code>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-1>1</a></span>
<span class=normal><a href=#__codelineno-29-2>2</a></span>
<span class=normal><a href=#__codelineno-29-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x11c0000000038d14 inst 2    
<a id=__codelineno-29-2 name=__codelineno-29-2></a>ModifyNH: Subcode=SetNH-Token(7),Desc=0x0,Data=0x38d14,NextNH=0
<a id=__codelineno-29-3 name=__codelineno-29-3></a> (pfeDest:20, TokenIdMode:0/  , VC memberId:0, isReass:0, token:0x38d/909)
</code></pre></div></td></tr></table></div> <p>We’ve reached the final forwarding result — which will set the forwarding NH index into the <strong>NH Token</strong>. Here, the token <code>0x38d</code> corresponds to the NH ID of our lookup result.</p> <p>You can get more info on this NH:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-1>1</a></span>
<span class=normal><a href=#__codelineno-30-2>2</a></span>
<span class=normal><a href=#__codelineno-30-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a>root@rtme-mx-62-fpc5:pfe&gt; show nh db index 0x38d 
<a id=__codelineno-30-2 name=__codelineno-30-2></a>Index          Type        Func-Type    Proto        Nh-Flags        Ifl-Name        Ifl-Index       Nh-Token        Nh-Prefix
<a id=__codelineno-30-3 name=__codelineno-30-3></a>909            Unicast     -            ipv4_tag     0x1             et-5/0/0.0      356             5187           ac100101/32         
</code></pre></div></td></tr></table></div> <p>Perfect — this matches expectations. Traffic targeting 8.8.8.0/24 via the FBF routing instance will be forwarded to the core interface <code>et-5/0/0.0</code>.</p> <p>You can dig deeper using this detailed view (to retrieve Layer 2 header information, MPLS encap...)</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-31-1> 1</a></span>
<span class=normal><a href=#__codelineno-31-2> 2</a></span>
<span class=normal><a href=#__codelineno-31-3> 3</a></span>
<span class=normal><a href=#__codelineno-31-4> 4</a></span>
<span class=normal><a href=#__codelineno-31-5> 5</a></span>
<span class=normal><a href=#__codelineno-31-6> 6</a></span>
<span class=normal><a href=#__codelineno-31-7> 7</a></span>
<span class=normal><a href=#__codelineno-31-8> 8</a></span>
<span class=normal><a href=#__codelineno-31-9> 9</a></span>
<span class=normal><a href=#__codelineno-31-10>10</a></span>
<span class=normal><a href=#__codelineno-31-11>11</a></span>
<span class=normal><a href=#__codelineno-31-12>12</a></span>
<span class=normal><a href=#__codelineno-31-13>13</a></span>
<span class=normal><a href=#__codelineno-31-14>14</a></span>
<span class=normal><a href=#__codelineno-31-15>15</a></span>
<span class=normal><a href=#__codelineno-31-16>16</a></span>
<span class=normal><a href=#__codelineno-31-17>17</a></span>
<span class=normal><a href=#__codelineno-31-18>18</a></span>
<span class=normal><a href=#__codelineno-31-19>19</a></span>
<span class=normal><a href=#__codelineno-31-20>20</a></span>
<span class=normal><a href=#__codelineno-31-21>21</a></span>
<span class=normal><a href=#__codelineno-31-22>22</a></span>
<span class=normal><a href=#__codelineno-31-23>23</a></span>
<span class=normal><a href=#__codelineno-31-24>24</a></span>
<span class=normal><a href=#__codelineno-31-25>25</a></span>
<span class=normal><a href=#__codelineno-31-26>26</a></span>
<span class=normal><a href=#__codelineno-31-27>27</a></span>
<span class=normal><a href=#__codelineno-31-28>28</a></span>
<span class=normal><a href=#__codelineno-31-29>29</a></span>
<span class=normal><a href=#__codelineno-31-30>30</a></span>
<span class=normal><a href=#__codelineno-31-31>31</a></span>
<span class=normal><a href=#__codelineno-31-32>32</a></span>
<span class=normal><a href=#__codelineno-31-33>33</a></span>
<span class=normal><a href=#__codelineno-31-34>34</a></span>
<span class=normal><a href=#__codelineno-31-35>35</a></span>
<span class=normal><a href=#__codelineno-31-36>36</a></span>
<span class=normal><a href=#__codelineno-31-37>37</a></span>
<span class=normal><a href=#__codelineno-31-38>38</a></span>
<span class=normal><a href=#__codelineno-31-39>39</a></span>
<span class=normal><a href=#__codelineno-31-40>40</a></span>
<span class=normal><a href=#__codelineno-31-41>41</a></span>
<span class=normal><a href=#__codelineno-31-42>42</a></span>
<span class=normal><a href=#__codelineno-31-43>43</a></span>
<span class=normal><a href=#__codelineno-31-44>44</a></span>
<span class=normal><a href=#__codelineno-31-45>45</a></span>
<span class=normal><a href=#__codelineno-31-46>46</a></span>
<span class=normal><a href=#__codelineno-31-47>47</a></span>
<span class=normal><a href=#__codelineno-31-48>48</a></span>
<span class=normal><a href=#__codelineno-31-49>49</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a>root@rtme-mx-62-fpc5:pfe&gt; show nh detail index 0x38d 
<a id=__codelineno-31-2 name=__codelineno-31-2></a>Nexthop Info:
<a id=__codelineno-31-3 name=__codelineno-31-3></a>
<a id=__codelineno-31-4 name=__codelineno-31-4></a>NH Index                      : 909
<a id=__codelineno-31-5 name=__codelineno-31-5></a>NH Type                       : Unicast
<a id=__codelineno-31-6 name=__codelineno-31-6></a>NH Proto                      : ipv4_tag
<a id=__codelineno-31-7 name=__codelineno-31-7></a>NH Flags                      : 0x1
<a id=__codelineno-31-8 name=__codelineno-31-8></a>IF Name                       : et-5/0/0.0
<a id=__codelineno-31-9 name=__codelineno-31-9></a>Prefix                        : ac100101/32
<a id=__codelineno-31-10 name=__codelineno-31-10></a>NH Token Id                   : 5187
<a id=__codelineno-31-11 name=__codelineno-31-11></a>NH Route Table Id             : 0
<a id=__codelineno-31-12 name=__codelineno-31-12></a>Sgid                          : 0
<a id=__codelineno-31-13 name=__codelineno-31-13></a>
<a id=__codelineno-31-14 name=__codelineno-31-14></a>OIF Index                     : 356
<a id=__codelineno-31-15 name=__codelineno-31-15></a>Underlying IFL                : .local..0 (0)
<a id=__codelineno-31-16 name=__codelineno-31-16></a>Session Id                    : 788
<a id=__codelineno-31-17 name=__codelineno-31-17></a>Num Tags                      : 1
<a id=__codelineno-31-18 name=__codelineno-31-18></a>Label                         : 0x4e22fff0 (20002)lbFlags: 0
<a id=__codelineno-31-19 name=__codelineno-31-19></a>MTU                           : 0
<a id=__codelineno-31-20 name=__codelineno-31-20></a>L2 Length                     : 12
<a id=__codelineno-31-21 name=__codelineno-31-21></a>L2 Data                       : 00:00:01:64:80:00:a8:d0:e5:ef:6a:87
<a id=__codelineno-31-22 name=__codelineno-31-22></a>Filter Index                  : 0
<a id=__codelineno-31-23 name=__codelineno-31-23></a>
<a id=__codelineno-31-24 name=__codelineno-31-24></a>Platform Info
<a id=__codelineno-31-25 name=__codelineno-31-25></a>-------------
<a id=__codelineno-31-26 name=__codelineno-31-26></a>  FabricToken: 5193
<a id=__codelineno-31-27 name=__codelineno-31-27></a>  EgressToken: 5192
<a id=__codelineno-31-28 name=__codelineno-31-28></a>  IngressFeatures:
<a id=__codelineno-31-29 name=__codelineno-31-29></a>
<a id=__codelineno-31-30 name=__codelineno-31-30></a>Container token: 5187
<a id=__codelineno-31-31 name=__codelineno-31-31></a>#5 SetNhToken tokens:
<a id=__codelineno-31-32 name=__codelineno-31-32></a> Mask : 0x0
<a id=__codelineno-31-33 name=__codelineno-31-33></a> [  SetNhToken:5186  ]
<a id=__codelineno-31-34 name=__codelineno-31-34></a>
<a id=__codelineno-31-35 name=__codelineno-31-35></a>  EgressFeatures:
<a id=__codelineno-31-36 name=__codelineno-31-36></a>
<a id=__codelineno-31-37 name=__codelineno-31-37></a>Container token: 5192
<a id=__codelineno-31-38 name=__codelineno-31-38></a>#2 PushLabels tokens:
<a id=__codelineno-31-39 name=__codelineno-31-39></a> Mask : 0x0
<a id=__codelineno-31-40 name=__codelineno-31-40></a> [  PushLabels:5188  ]
<a id=__codelineno-31-41 name=__codelineno-31-41></a>#4 StatsCounter tokens:
<a id=__codelineno-31-42 name=__codelineno-31-42></a> Mask : 0x1
<a id=__codelineno-31-43 name=__codelineno-31-43></a> [  StatsCounter:5189  ]
<a id=__codelineno-31-44 name=__codelineno-31-44></a>#11 UcastEncap tokens:
<a id=__codelineno-31-45 name=__codelineno-31-45></a> Mask : 0x0
<a id=__codelineno-31-46 name=__codelineno-31-46></a> [  UcastEncap:5190  ]
<a id=__codelineno-31-47 name=__codelineno-31-47></a>#12 SetOIF tokens:
<a id=__codelineno-31-48 name=__codelineno-31-48></a> Mask : 0x0
<a id=__codelineno-31-49 name=__codelineno-31-49></a> [  SetOIF:5191  ]  
</code></pre></div></td></tr></table></div> <p>If we repeat the exercise with the 8.8.8.0/24 prefix no longer present in the <code>FBF.inet.0</code> table, any traffic destined for 8.8.8.0/24 will match the default 0/0 route, which redirects to the <code>inet.0</code> table via a <code>next-table</code> action. In this scenario, we would notice slightly longer processing — just a few extra instructions — due to the need for two lookups:</p> <ul> <li>The first lookup occurs in the FBF FIB instance, which triggers the <strong>next-table</strong> action and redirects the processing to the main IPv4 <code>inet.0</code> table,</li> <li>The second lookup happens in the <code>inet.0</code> FIB, where the best route to 8.8.8.0/24 is selected—in our case, through interface et-2/0/0.0, which connects to our PNI.</li> </ul> <blockquote> <p>In this situation, two KTREE structures are involved: first the <code>FBF.inet.0</code> KTREE, followed by the <code>inet.0</code> KTREE.</p> </blockquote> <p>and another table - just for illustration</p> <table> <thead> <tr> <th>PFE COMPLEX</th> <th>Port Number</th> <th>10GE mode</th> </tr> </thead> <tbody> <tr> <td>EA ASIC 0</td> <td>0</td> <td>xe-0/1/0</td> </tr> <tr> <td></td> <td>1</td> <td>xe-0/1/1</td> </tr> <tr> <td></td> <td>2</td> <td>xe-0/1/2</td> </tr> <tr> <td></td> <td>3</td> <td>xe-0/1/3</td> </tr> <tr> <td></td> <td>4</td> <td>xe-0/1/4</td> </tr> <tr> <td></td> <td>5</td> <td>xe-0/1/5</td> </tr> <tr> <td></td> <td>6</td> <td>xe-0/1/6</td> </tr> <tr> <td></td> <td>7</td> <td>xe-0/1/7</td> </tr> </tbody> </table><p class=table-caption style="text-align:center; font-style:italic;">Table 1: Interface Naming of the 8xSFP+ PIC</p> <p>The following figure provides a consolidated view of the packet traversal process and outlines the key steps of the FBF mechanism:</p> <p><figure><img alt="FBF with rib-group at PFE level" src=../images/PFE-FBF-2.png><figcaption>Figure 5: FBF with rib-group at PFE level</figcaption></figure></p> <p>This is a test to refer to this <a href=../chapter1/#overall-behavior>section</a></p> <h2 id=conclusion>1.4. Conclusion<a class=headerlink href=#conclusion title="Permanent link">¶</a></h2> <p>In this article, we explored the mechanics of the <strong>Filter-Based Forwarding (FBF)</strong> feature, focusing on how traffic steering is implemented at the PFE level. We demonstrated <strong>two distinct approaches</strong> to configuring and validating FBF behavior. While both are effective, the second method provides <strong>greater flexibility</strong>, making it especially useful for advanced use cases.</p> <p>All tests and examples provided were conducted within the <strong>IPv4 address family</strong>, but it's important to highlight that the same FBF logic and infrastructure are <strong>fully supported for IPv6</strong> as well, offering consistent behavior across protocol versions.</p> <p>By understanding the inner workings of FBF down to the hardware abstraction layer, network engineers can confidently design and validate sophisticated traffic steering policies.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../chapter2/ class="md-footer__link md-footer__link--prev" aria-label="Previous: FBF Use Case 1"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> FBF Use Case 1 </div> </div> </a> <a href=../../about/ class="md-footer__link md-footer__link--next" aria-label="Next: About us"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> About us </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> This site is maintained by HPE/Juniper Networking employees. Powered by Material for MkDocs & Pandoc </div> </div> <div class=md-social> <a href=https://www.linkedin.com/company/juniper-networks target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/juniper target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["toc.follow", "navigation.top", "navigation.tabs", "navigation.instant", "navigation.footer", "navigation.indexes", "search.suggest", "content.code.annotate", "content.code.copy", "content.code.select", "content.action.edit", "content.tooltips", "content.footnote.tooltips"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js></script> <script src=../../js/math-render.js></script> <script src=../../js/extra.js></script> </body> </html>
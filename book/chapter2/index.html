<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="HPE Juniper TME Team"><link href=../chapter1/ rel=prev><link href=../chapter3/ rel=next><link rel=icon href=../../images/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.9"><title>FBF Use Case 1 - Day One books - A technical eBook collection by HPE Juniper Networking</title><link rel=stylesheet href=../../assets/stylesheets/main.4af4bdda.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CNova:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Google Sans";--md-code-font:"Nova"}</style><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#case-1---fbf-using-next-ip-next-interface-actions class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Day One books - A technical eBook collection by HPE Juniper Networking" class="md-header__button md-logo" aria-label="Day One books - A technical eBook collection by HPE Juniper Networking" data-md-component=logo> <img src=../../images/favicon.ico alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Day One books - A technical eBook collection by HPE Juniper Networking </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> FBF Use Case 1 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../chapter1/ class=md-tabs__link> The Book </a> </li> <li class=md-tabs__item> <a href=../../download/dayonebooks.pdf class=md-tabs__link> PDF Book </a> </li> <li class=md-tabs__item> <a href=../../download/dayonebooks.epub class=md-tabs__link> ePUB Book </a> </li> <li class=md-tabs__item> <a href=../../about/ class=md-tabs__link> About us </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Day One books - A technical eBook collection by HPE Juniper Networking" class="md-nav__button md-logo" aria-label="Day One books - A technical eBook collection by HPE Juniper Networking" data-md-component=logo> <img src=../../images/favicon.ico alt=logo> </a> Day One books - A technical eBook collection by HPE Juniper Networking </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> The Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> The Book </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> The Sample Day One Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> The Sample Day One Book </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter1/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> FBF Use Case 1 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> FBF Use Case 1 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overall-behavior class=md-nav__link> <span class=md-ellipsis> 1.1. Overall Behavior </span> </a> </li> <li class=md-nav__item> <a href=#caveats class=md-nav__link> <span class=md-ellipsis> 1.2. Caveats </span> </a> </li> <li class=md-nav__item> <a href=#example-1---topology class=md-nav__link> <span class=md-ellipsis> 1.3. Example 1 - topology </span> </a> </li> <li class=md-nav__item> <a href=#pfe-analysis class=md-nav__link> <span class=md-ellipsis> 1.4. PFE analysis </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../chapter3/ class=md-nav__link> <span class=md-ellipsis> FBF use Case 2 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../download/dayonebooks.pdf class=md-nav__link> <span class=md-ellipsis> PDF Book </span> </a> </li> <li class=md-nav__item> <a href=../../download/dayonebooks.epub class=md-nav__link> <span class=md-ellipsis> ePUB Book </span> </a> </li> <li class=md-nav__item> <a href=../../about/ class=md-nav__link> <span class=md-ellipsis> About us </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overall-behavior class=md-nav__link> <span class=md-ellipsis> 1.1. Overall Behavior </span> </a> </li> <li class=md-nav__item> <a href=#caveats class=md-nav__link> <span class=md-ellipsis> 1.2. Caveats </span> </a> </li> <li class=md-nav__item> <a href=#example-1---topology class=md-nav__link> <span class=md-ellipsis> 1.3. Example 1 - topology </span> </a> </li> <li class=md-nav__item> <a href=#pfe-analysis class=md-nav__link> <span class=md-ellipsis> 1.4. PFE analysis </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=case-1---fbf-using-next-ip-next-interface-actions>1. Case 1 - FBF Using next-ip / next-interface Actions<a class=headerlink href=#case-1---fbf-using-next-ip-next-interface-actions title="Permanent link">¶</a></h1> <p><a href="https://deepthought.juniper.net/app/do/showView?taskCode=all&record_code=14784-1&tableName=RLI&record_number=14784">RLI 14784</a> introduces two new terminating actions in firewall filters:</p> <ul> <li>next-interface <intf-name> routing-instance <ri-name></ri-name></intf-name></li> <li>next-ip <prefix> routing-instance <ri-name></ri-name></prefix></li> </ul> <blockquote> <p><strong>Note:</strong> IPv6 is also supported via the <code>next-ip6</code> variant.</p> </blockquote> <p>These actions are <strong>terminating</strong>, meaning there's no need to include an explicit <code>accept</code> statement. Both are supported under the <code>inet</code> and <code>inet6</code> families.</p> <p>The typical usage for these actions is illustrated below:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1> 1</a></span>
<span class=normal><a href=#__codelineno-0-2> 2</a></span>
<span class=normal><a href=#__codelineno-0-3> 3</a></span>
<span class=normal><a href=#__codelineno-0-4> 4</a></span>
<span class=normal><a href=#__codelineno-0-5> 5</a></span>
<span class=normal><a href=#__codelineno-0-6> 6</a></span>
<span class=normal><a href=#__codelineno-0-7> 7</a></span>
<span class=normal><a href=#__codelineno-0-8> 8</a></span>
<span class=normal><a href=#__codelineno-0-9> 9</a></span>
<span class=normal><a href=#__codelineno-0-10>10</a></span>
<span class=normal><a href=#__codelineno-0-11>11</a></span>
<span class=normal><a href=#__codelineno-0-12>12</a></span>
<span class=normal><a href=#__codelineno-0-13>13</a></span>
<span class=normal><a href=#__codelineno-0-14>14</a></span>
<span class=normal><a href=#__codelineno-0-15>15</a></span>
<span class=normal><a href=#__codelineno-0-16>16</a></span>
<span class=normal><a href=#__codelineno-0-17>17</a></span>
<span class=normal><a href=#__codelineno-0-18>18</a></span>
<span class=normal><a href=#__codelineno-0-19>19</a></span>
<span class=normal><a href=#__codelineno-0-20>20</a></span>
<span class=normal><a href=#__codelineno-0-21>21</a></span>
<span class=normal><a href=#__codelineno-0-22>22</a></span>
<span class=normal><a href=#__codelineno-0-23>23</a></span>
<span class=normal><a href=#__codelineno-0-24>24</a></span>
<span class=normal><a href=#__codelineno-0-25>25</a></span>
<span class=normal><a href=#__codelineno-0-26>26</a></span>
<span class=normal><a href=#__codelineno-0-27>27</a></span>
<span class=normal><a href=#__codelineno-0-28>28</a></span>
<span class=normal><a href=#__codelineno-0-29>29</a></span>
<span class=normal><a href=#__codelineno-0-30>30</a></span>
<span class=normal><a href=#__codelineno-0-31>31</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a>firewall {
<a id=__codelineno-0-2 name=__codelineno-0-2></a>    family inet|inet6 {
<a id=__codelineno-0-3 name=__codelineno-0-3></a>      filter foo {
<a id=__codelineno-0-4 name=__codelineno-0-4></a>        from { 
<a id=__codelineno-0-5 name=__codelineno-0-5></a>          Any from the set of ip match conditions
<a id=__codelineno-0-6 name=__codelineno-0-6></a>        } then {
<a id=__codelineno-0-7 name=__codelineno-0-7></a>          next-interface &lt;intf-name&gt; routing-instance &lt;RI-name&gt;
<a id=__codelineno-0-8 name=__codelineno-0-8></a>      }
<a id=__codelineno-0-9 name=__codelineno-0-9></a>    }
<a id=__codelineno-0-10 name=__codelineno-0-10></a>  }
<a id=__codelineno-0-11 name=__codelineno-0-11></a>
<a id=__codelineno-0-12 name=__codelineno-0-12></a>  family inet {
<a id=__codelineno-0-13 name=__codelineno-0-13></a>      filter foo4 {
<a id=__codelineno-0-14 name=__codelineno-0-14></a>        from { 
<a id=__codelineno-0-15 name=__codelineno-0-15></a>          Any from the set of ipv4 match conditions
<a id=__codelineno-0-16 name=__codelineno-0-16></a>        } then {
<a id=__codelineno-0-17 name=__codelineno-0-17></a>          next-ip &lt;prefix&gt; routing-instance &lt;RI-name&gt;
<a id=__codelineno-0-18 name=__codelineno-0-18></a>      }
<a id=__codelineno-0-19 name=__codelineno-0-19></a>    }
<a id=__codelineno-0-20 name=__codelineno-0-20></a>  }
<a id=__codelineno-0-21 name=__codelineno-0-21></a>
<a id=__codelineno-0-22 name=__codelineno-0-22></a>  family inet6 {
<a id=__codelineno-0-23 name=__codelineno-0-23></a>      filter foo6 {
<a id=__codelineno-0-24 name=__codelineno-0-24></a>        from { 
<a id=__codelineno-0-25 name=__codelineno-0-25></a>          Any from the set of ipv6 match conditions
<a id=__codelineno-0-26 name=__codelineno-0-26></a>        } then {
<a id=__codelineno-0-27 name=__codelineno-0-27></a>          next-ip6 &lt;prefix&gt; routing-instance &lt;RI-name&gt;
<a id=__codelineno-0-28 name=__codelineno-0-28></a>      }
<a id=__codelineno-0-29 name=__codelineno-0-29></a>    }
<a id=__codelineno-0-30 name=__codelineno-0-30></a>  }
<a id=__codelineno-0-31 name=__codelineno-0-31></a>}
</code></pre></div></td></tr></table></div> <h2 id=overall-behavior>1.1. Overall Behavior<a class=headerlink href=#overall-behavior title="Permanent link">¶</a></h2> <p>When a packet matches a term using one of the below actions:</p> <ul> <li><strong><code>next-interface</code></strong>: The system verifies the operational state of the specified interface, along with the availability of an ARP (or ND for IPv6) entry for the next-hop. If a <code>routing-instance</code> is specified, the interface lookup is performed within that context. If all conditions are met, the packet is forwarded via the corresponding egress IFL. If the interface is down or unresolved, the packet is dropped.</li> <li><strong><code>next-ip(6)</code></strong>: The IP address specified in <code>next-ip</code> or <code>next-ip6</code> is not automatically resolved. On Ethernet interfaces, reachability must be ensured through routing—either via dynamic protocols or static routes. If a matching route (exact or more specific) is found, the packet follows the next-hop associated with that route. If no matching route exists, the packet is <strong>rejected</strong>.</li> </ul> <p>Read carefully: if next-ip address becomes unreachable the default approch is to point the traffic to the default reject next-hop. Traffic rejected are thus punted to the RE for sending back an ICMP unreachable. However, no worries about "overloading" the internal host-path. Indeed, there is a default DDOS protection policer that will rate-limit those rejected punted packets to 2Kpps. We will see later, how to handle this behavior in case you want silencly discard the packet when next-ip address becomes unreachable. </p> <h2 id=caveats>1.2. Caveats<a class=headerlink href=#caveats title="Permanent link">¶</a></h2> <p>Known limitations include:</p> <ul> <li>Supported only for <strong>ingress</strong> filtering</li> <li>No fallback mechanism (The EVO <strong>exact</strong> match option is not supported)</li> <li>Not supported on <strong>LT</strong> interfaces</li> </ul> <h2 id=example-1---topology>1.3. Example 1 - topology<a class=headerlink href=#example-1---topology title="Permanent link">¶</a></h2> <p>The diagram below illustrates the topology used to demonstrate simple FBF on an MX platform.<br> The Device Under Test (<strong>DUT</strong>) is an <strong>MX480</strong> equipped with an <strong>MPC10E</strong> line card.</p> <p>This simplified setup represents a typical <strong>DCI</strong> router connected to an <strong>IP Fabric</strong>, providing access to remote resources via two distinct paths:</p> <ul> <li>A <strong>quality</strong> path through an <strong>MPLS/SR</strong> core network, and</li> <li>A <strong>best-effort</strong> path via a <strong>direct peering or transit (PNI)</strong> connection.</li> </ul> <p>By default, remote resources are reached via the direct PNI link. The DUT hosts an <strong>Internet VRF</strong>, which is also used by a remote <strong>ASBR</strong> in the same AS. This ASBR advertises "public/remote" prefixes to all PE routers—including the DUT—via <strong>L3VPN (inet-vpn)</strong>. The direct PNI interface is also part of the Internet VRF.</p> <p><figure><img alt="Network topology" src=../images/diag1.png><figcaption>Figure 1: Network topology</figcaption></figure></p> <p>For demonstration purposes, the remote resource is simulated using the public prefix <strong>8.8.8.0/24</strong>. This prefix is preferred by default via the direct PNI, with a backup path available through the MPLS/SR core:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-1> 1</a></span>
<span class=normal><a href=#__codelineno-1-2> 2</a></span>
<span class=normal><a href=#__codelineno-1-3> 3</a></span>
<span class=normal><a href=#__codelineno-1-4> 4</a></span>
<span class=normal><a href=#__codelineno-1-5> 5</a></span>
<span class=normal><a href=#__codelineno-1-6> 6</a></span>
<span class=normal><a href=#__codelineno-1-7> 7</a></span>
<span class=normal><a href=#__codelineno-1-8> 8</a></span>
<span class=normal><a href=#__codelineno-1-9> 9</a></span>
<span class=normal><a href=#__codelineno-1-10>10</a></span>
<span class=normal><a href=#__codelineno-1-11>11</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a>regress@rtme-mx-62&gt; show route 8.8.8.0/24 
<a id=__codelineno-1-2 name=__codelineno-1-2></a>
<a id=__codelineno-1-3 name=__codelineno-1-3></a>VRF1.inet.0: 9 destinations, 13 routes (9 active, 0 holddown, 0 hidden)
<a id=__codelineno-1-4 name=__codelineno-1-4></a>+ = Active Route, - = Last Active, * = Both
<a id=__codelineno-1-5 name=__codelineno-1-5></a>
<a id=__codelineno-1-6 name=__codelineno-1-6></a>8.8.8.0/24         *[BGP/170] 00:00:04, localpref 10000
<a id=__codelineno-1-7 name=__codelineno-1-7></a>                      AS path: 1234 6000 I, validation-state: unverified
<a id=__codelineno-1-8 name=__codelineno-1-8></a>                    &gt;  to 172.16.8.1 via et-2/0/0.0                             &lt;&lt;&lt; Via PNI
<a id=__codelineno-1-9 name=__codelineno-1-9></a>                    [BGP/170] 21:23:18, localpref 100, from 193.252.102.201
<a id=__codelineno-1-10 name=__codelineno-1-10></a>                      AS path: I, validation-state: unverified
<a id=__codelineno-1-11 name=__codelineno-1-11></a>                    &gt;  to 172.16.1.1 via et-5/0/0.0, Push 16, Push 20103(top)   &lt;&lt;&lt; Via MPLS/SR Core
</code></pre></div></td></tr></table></div> <p>The IP Fabric serves two customer types—<strong>A</strong> and <strong>B</strong>—represented by IP prefixes <strong>172.111.0.0/24</strong> and <strong>172.222.0.0/24</strong>, respectively. The DUT exchanges IP traffic with these customers directly.</p> <p>This is just a table for test:</p> <table> <thead> <tr> <th>PFE COMPLEX</th> <th>Port Number</th> <th>10GE mode</th> <th>40GE or 100GE modes</th> </tr> </thead> <tbody> <tr> <td>EA ASIC 0</td> <td>0</td> <td>xe-x/1/0:[0..3]</td> <td>et-x/1/0</td> </tr> <tr> <td></td> <td>1</td> <td>xe-x/1/1:[0..3]</td> <td>et-x/1/1</td> </tr> <tr> <td></td> <td>2</td> <td>xe-x/1/2:[0..3]</td> <td>et-x/1/2</td> </tr> <tr> <td></td> <td>3</td> <td>xe-x/1/3:[0..3]</td> <td>et-x/1/3</td> </tr> <tr> <td>EA ASIC 1</td> <td>4</td> <td>xe-x/1/4:[0..3]</td> <td>et-x/1/4</td> </tr> <tr> <td></td> <td>5</td> <td>xe-x/1/5:[0..3]</td> <td>et-x/1/5</td> </tr> <tr> <td></td> <td>6</td> <td>xe-x/1/6:[0..3]</td> <td>et-x/1/6</td> </tr> <tr> <td></td> <td>7</td> <td>xe-x/1/7:[0..3]</td> <td>et-x/1/7</td> </tr> <tr> <td>EA ASIC 2</td> <td>8</td> <td>xe-x/1/8:[0..3]</td> <td>et-x/1/8</td> </tr> <tr> <td></td> <td>9</td> <td>xe-x/1/9:[0..3]</td> <td>et-x/1/9</td> </tr> <tr> <td></td> <td>10</td> <td>xe-x/1/10:[0..3]</td> <td>et-x/1/10</td> </tr> <tr> <td></td> <td>11</td> <td>xe-x/1/11:[0..3]</td> <td>et-x/1/11</td> </tr> </tbody> </table><p class=table-caption style="text-align:center; font-style:italic;">Table 1: Interface Naming of the 6xQSFPP PIC</p> <p><strong>Initial Configuration</strong></p> <p>Below is the initial configuration for the DUT's <strong>Internet VRF</strong>, kept simple for clarity:</p> <ul> <li>The DUT receives customer prefixes via <strong>eBGP</strong> from the peer group <strong>FABRIC</strong>.</li> <li>It receives public prefixes from the peer ASBR via <strong>eBGP</strong>, with an import policy (<strong>PREF</strong>) setting a high <strong>local preference</strong> to make this path the best.</li> <li>Two interfaces belong to the Internet VRF—one facing the IP Fabric, and the other towards the PNI peer.</li> <li>The DUT also connects to the MPLS core, running <strong>IS-IS with Segment Routing</strong> for label distribution.</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-1> 1</a></span>
<span class=normal><a href=#__codelineno-2-2> 2</a></span>
<span class=normal><a href=#__codelineno-2-3> 3</a></span>
<span class=normal><a href=#__codelineno-2-4> 4</a></span>
<span class=normal><a href=#__codelineno-2-5> 5</a></span>
<span class=normal><a href=#__codelineno-2-6> 6</a></span>
<span class=normal><a href=#__codelineno-2-7> 7</a></span>
<span class=normal><a href=#__codelineno-2-8> 8</a></span>
<span class=normal><a href=#__codelineno-2-9> 9</a></span>
<span class=normal><a href=#__codelineno-2-10>10</a></span>
<span class=normal><a href=#__codelineno-2-11>11</a></span>
<span class=normal><a href=#__codelineno-2-12>12</a></span>
<span class=normal><a href=#__codelineno-2-13>13</a></span>
<span class=normal><a href=#__codelineno-2-14>14</a></span>
<span class=normal><a href=#__codelineno-2-15>15</a></span>
<span class=normal><a href=#__codelineno-2-16>16</a></span>
<span class=normal><a href=#__codelineno-2-17>17</a></span>
<span class=normal><a href=#__codelineno-2-18>18</a></span>
<span class=normal><a href=#__codelineno-2-19>19</a></span>
<span class=normal><a href=#__codelineno-2-20>20</a></span>
<span class=normal><a href=#__codelineno-2-21>21</a></span>
<span class=normal><a href=#__codelineno-2-22>22</a></span>
<span class=normal><a href=#__codelineno-2-23>23</a></span>
<span class=normal><a href=#__codelineno-2-24>24</a></span>
<span class=normal><a href=#__codelineno-2-25>25</a></span>
<span class=normal><a href=#__codelineno-2-26>26</a></span>
<span class=normal><a href=#__codelineno-2-27>27</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a>regress@rtme-mx-62&gt; show configuration routing-instances VRF1 
<a id=__codelineno-2-2 name=__codelineno-2-2></a>instance-type vrf;
<a id=__codelineno-2-3 name=__codelineno-2-3></a>protocols {
<a id=__codelineno-2-4 name=__codelineno-2-4></a>    bgp {
<a id=__codelineno-2-5 name=__codelineno-2-5></a>        group FABRIC {
<a id=__codelineno-2-6 name=__codelineno-2-6></a>            type external;
<a id=__codelineno-2-7 name=__codelineno-2-7></a>            local-address 172.16.0.4;
<a id=__codelineno-2-8 name=__codelineno-2-8></a>            peer-as 5000;
<a id=__codelineno-2-9 name=__codelineno-2-9></a>            neighbor 172.16.0.5;
<a id=__codelineno-2-10 name=__codelineno-2-10></a>        }
<a id=__codelineno-2-11 name=__codelineno-2-11></a>        group PEER {
<a id=__codelineno-2-12 name=__codelineno-2-12></a>            type external;
<a id=__codelineno-2-13 name=__codelineno-2-13></a>            local-address 172.16.8.0;
<a id=__codelineno-2-14 name=__codelineno-2-14></a>            import PREF;
<a id=__codelineno-2-15 name=__codelineno-2-15></a>            family inet {
<a id=__codelineno-2-16 name=__codelineno-2-16></a>                unicast;
<a id=__codelineno-2-17 name=__codelineno-2-17></a>            }
<a id=__codelineno-2-18 name=__codelineno-2-18></a>            peer-as 1234;
<a id=__codelineno-2-19 name=__codelineno-2-19></a>            neighbor 172.16.8.1;
<a id=__codelineno-2-20 name=__codelineno-2-20></a>        }
<a id=__codelineno-2-21 name=__codelineno-2-21></a>    }
<a id=__codelineno-2-22 name=__codelineno-2-22></a>}
<a id=__codelineno-2-23 name=__codelineno-2-23></a>interface et-4/0/0.0;
<a id=__codelineno-2-24 name=__codelineno-2-24></a>interface et-5/2/0.100;
<a id=__codelineno-2-25 name=__codelineno-2-25></a>route-distinguisher 193.252.102.101:1;
<a id=__codelineno-2-26 name=__codelineno-2-26></a>vrf-target target:65000:1234;
<a id=__codelineno-2-27 name=__codelineno-2-27></a>vrf-table-label;
</code></pre></div></td></tr></table></div> <p><strong>Configuration of FBF</strong></p> <p>Using the previous topology, we demonstrate a typical FBF use case leveraging the <strong><code>next-ip</code></strong> action (the same behavior applies to <strong><code>next-ip6</code></strong> and <strong><code>next-interface</code></strong>).</p> <p>The objective is to override the default forwarding behavior—where traffic exits via the direct PNI interface—for traffic sourced from <strong>Customer B</strong> (<strong>172.222.0.0/24</strong>). Instead, traffic from this prefix should be redirected through the <strong>MPLS backbone</strong>, targeting the remote ASBR to reach the public resource.</p> <p>Traffic from other sources will continue to follow the default “best path,” which remains the direct PNI link.</p> <p>The diagram below illustrates this behavior:</p> <p><figure><img alt="Source based forwarding with next-ip" src=../images/diag2.png><figcaption>Figure 2: Source based forwarding with next-ip</figcaption></figure></p> <p><strong>How will we achieve this?</strong></p> <p>The configuration is straightforward. First, we define a firewall filter that matches the source prefix <strong>172.222.0.0/24</strong>, and apply the <code>next-ip</code> action to redirect traffic.</p> <p>Which <code>next-ip</code> address should be used?<br> That depends on the network design. In this example, we target the <strong>loopback address of the remote ASBR</strong>, which is advertised via <strong>BGP (L3VPN)</strong>. As shown below, the route to this loopback is reachable through the MPLS/SR core via an established tunnel:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-1>1</a></span>
<span class=normal><a href=#__codelineno-3-2>2</a></span>
<span class=normal><a href=#__codelineno-3-3>3</a></span>
<span class=normal><a href=#__codelineno-3-4>4</a></span>
<span class=normal><a href=#__codelineno-3-5>5</a></span>
<span class=normal><a href=#__codelineno-3-6>6</a></span>
<span class=normal><a href=#__codelineno-3-7>7</a></span>
<span class=normal><a href=#__codelineno-3-8>8</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a>regress@rtme-mx-62&gt; show route 192.168.1.1 table VRF1.inet   
<a id=__codelineno-3-2 name=__codelineno-3-2></a>
<a id=__codelineno-3-3 name=__codelineno-3-3></a>VRF1.inet.0: 9 destinations, 13 routes (9 active, 0 holddown, 0 hidden)
<a id=__codelineno-3-4 name=__codelineno-3-4></a>+ = Active Route, - = Last Active, * = Both
<a id=__codelineno-3-5 name=__codelineno-3-5></a>
<a id=__codelineno-3-6 name=__codelineno-3-6></a>192.168.1.1/32     *[BGP/170] 20:42:26, localpref 100, from 193.252.102.201
<a id=__codelineno-3-7 name=__codelineno-3-7></a>                      AS path: I, validation-state: unverified
<a id=__codelineno-3-8 name=__codelineno-3-8></a>                    &gt;  to 172.16.1.1 via et-5/0/0.0, Push 16, Push 20103(top)
</code></pre></div></td></tr></table></div> <p>Now let's configure the FBF filter. Since we're operating within a <strong>VRF context</strong>, the <code>routing-instance</code> parameter is specified along with the <code>next-ip</code> action—this ensures that the next-hop lookup is performed in the correct <strong>FIB instance</strong>.</p> <p>An additional term is included to match all remaining traffic, allowing it to follow the default forwarding behavior.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-4-1> 1</a></span>
<span class=normal><a href=#__codelineno-4-2> 2</a></span>
<span class=normal><a href=#__codelineno-4-3> 3</a></span>
<span class=normal><a href=#__codelineno-4-4> 4</a></span>
<span class=normal><a href=#__codelineno-4-5> 5</a></span>
<span class=normal><a href=#__codelineno-4-6> 6</a></span>
<span class=normal><a href=#__codelineno-4-7> 7</a></span>
<span class=normal><a href=#__codelineno-4-8> 8</a></span>
<span class=normal><a href=#__codelineno-4-9> 9</a></span>
<span class=normal><a href=#__codelineno-4-10>10</a></span>
<span class=normal><a href=#__codelineno-4-11>11</a></span>
<span class=normal><a href=#__codelineno-4-12>12</a></span>
<span class=normal><a href=#__codelineno-4-13>13</a></span>
<span class=normal><a href=#__codelineno-4-14>14</a></span>
<span class=normal><a href=#__codelineno-4-15>15</a></span>
<span class=normal><a href=#__codelineno-4-16>16</a></span>
<span class=normal><a href=#__codelineno-4-17>17</a></span>
<span class=normal><a href=#__codelineno-4-18>18</a></span>
<span class=normal><a href=#__codelineno-4-19>19</a></span>
<span class=normal><a href=#__codelineno-4-20>20</a></span>
<span class=normal><a href=#__codelineno-4-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a>family inet {
<a id=__codelineno-4-2 name=__codelineno-4-2></a>    filter FBF {
<a id=__codelineno-4-3 name=__codelineno-4-3></a>        term PBR_CUSTOMER_B {
<a id=__codelineno-4-4 name=__codelineno-4-4></a>            from {
<a id=__codelineno-4-5 name=__codelineno-4-5></a>                source-address {
<a id=__codelineno-4-6 name=__codelineno-4-6></a>                    172.222.0.0/24;
<a id=__codelineno-4-7 name=__codelineno-4-7></a>                }
<a id=__codelineno-4-8 name=__codelineno-4-8></a>            }
<a id=__codelineno-4-9 name=__codelineno-4-9></a>            then {
<a id=__codelineno-4-10 name=__codelineno-4-10></a>                count CUSTOMERB;
<a id=__codelineno-4-11 name=__codelineno-4-11></a>                next-ip 192.168.1.1/32 routing-instance VRF1;
<a id=__codelineno-4-12 name=__codelineno-4-12></a>            }
<a id=__codelineno-4-13 name=__codelineno-4-13></a>        }
<a id=__codelineno-4-14 name=__codelineno-4-14></a>        term OTHER {
<a id=__codelineno-4-15 name=__codelineno-4-15></a>            then {
<a id=__codelineno-4-16 name=__codelineno-4-16></a>                count OTHER;
<a id=__codelineno-4-17 name=__codelineno-4-17></a>                accept;
<a id=__codelineno-4-18 name=__codelineno-4-18></a>            }
<a id=__codelineno-4-19 name=__codelineno-4-19></a>        }
<a id=__codelineno-4-20 name=__codelineno-4-20></a>    }
<a id=__codelineno-4-21 name=__codelineno-4-21></a>}
</code></pre></div></td></tr></table></div> <p>Before applying the filter, we'll generate traffic from <strong>Customer A</strong> and <strong>Customer B</strong>. To distinguish between the two flows, we configure the traffic rates as follows:</p> <ul> <li><strong>Customer A</strong>: 1000 packets per second (pps)</li> <li><strong>Customer B</strong>: 5000 packets per second (pps)</li> </ul> <p>Both customers will send traffic toward the <strong>8.8.8.0/24</strong> prefix.</p> <p>We now start the traffic and verify the statistics on the <strong>PNI interface</strong>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-5-1>1</a></span>
<span class=normal><a href=#__codelineno-5-2>2</a></span>
<span class=normal><a href=#__codelineno-5-3>3</a></span>
<span class=normal><a href=#__codelineno-5-4>4</a></span>
<span class=normal><a href=#__codelineno-5-5>5</a></span>
<span class=normal><a href=#__codelineno-5-6>6</a></span>
<span class=normal><a href=#__codelineno-5-7>7</a></span>
<span class=normal><a href=#__codelineno-5-8>8</a></span>
<span class=normal><a href=#__codelineno-5-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a>regress@rtme-mx-62&gt; monitor interface et-2/0/0.0   
<a id=__codelineno-5-2 name=__codelineno-5-2></a>
<a id=__codelineno-5-3 name=__codelineno-5-3></a>&lt;- truncated output -&gt;
<a id=__codelineno-5-4 name=__codelineno-5-4></a>
<a id=__codelineno-5-5 name=__codelineno-5-5></a>Remote statistics:
<a id=__codelineno-5-6 name=__codelineno-5-6></a>  Input bytes:                 132708516 (0 bps)                           [0]
<a id=__codelineno-5-7 name=__codelineno-5-7></a>  Output bytes:              48292808336 (23518344 bps)             [11195520]
<a id=__codelineno-5-8 name=__codelineno-5-8></a>  Input packets:                  270844 (0 pps)                           [0]
<a id=__codelineno-5-9 name=__codelineno-5-9></a>  Output packets:               98556757 (6000 pps)                    [22848] &lt;&lt;&lt; Customer A + Customer B traffics
</code></pre></div></td></tr></table></div> <p>At this point, all traffic is following the best active path—via the <strong>PNI interface</strong>—to reach the <strong>8.8.8.0/24</strong> prefix.</p> <p>Another table just for test:</p> <table> <thead> <tr> <th>PFE COMPLEX</th> <th>Port Number</th> <th>10GE mode</th> <th>40GE or 100GE mode</th> </tr> </thead> <tbody> <tr> <td>EA ASIC 0</td> <td>0</td> <td>xe-0/0/0:[0..3]</td> <td>et-0/0/0</td> </tr> <tr> <td></td> <td>1</td> <td>xe-0/0/1:[0..3]</td> <td>et-0/0/1</td> </tr> <tr> <td></td> <td>2</td> <td>xe-0/0/2:[0..3]</td> <td>et-0/0/2</td> </tr> <tr> <td></td> <td>3</td> <td>xe-0/0/3:[0..3]</td> <td>et-0/0/3</td> </tr> </tbody> </table><p class=table-caption style="text-align:center; font-style:italic;">Table 2: Interface Naming of the 4xQSFPP PIC</p> <p>We now apply the <strong>FBF filter</strong> in the <strong>ingress</strong> direction on the interface connected to the <strong>IP Fabric</strong>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-6-1>1</a></span>
<span class=normal><a href=#__codelineno-6-2>2</a></span>
<span class=normal><a href=#__codelineno-6-3>3</a></span>
<span class=normal><a href=#__codelineno-6-4>4</a></span>
<span class=normal><a href=#__codelineno-6-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a>edit private
<a id=__codelineno-6-2 name=__codelineno-6-2></a>
<a id=__codelineno-6-3 name=__codelineno-6-3></a>set interfaces et-5/2/0 unit 100 family inet filter input FBF
<a id=__codelineno-6-4 name=__codelineno-6-4></a>
<a id=__codelineno-6-5 name=__codelineno-6-5></a>commit comment "ADD_FBF" and-quit
</code></pre></div></td></tr></table></div> <p>And then, recheck the PNI interface statistics: </p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-1> 1</a></span>
<span class=normal><a href=#__codelineno-7-2> 2</a></span>
<span class=normal><a href=#__codelineno-7-3> 3</a></span>
<span class=normal><a href=#__codelineno-7-4> 4</a></span>
<span class=normal><a href=#__codelineno-7-5> 5</a></span>
<span class=normal><a href=#__codelineno-7-6> 6</a></span>
<span class=normal><a href=#__codelineno-7-7> 7</a></span>
<span class=normal><a href=#__codelineno-7-8> 8</a></span>
<span class=normal><a href=#__codelineno-7-9> 9</a></span>
<span class=normal><a href=#__codelineno-7-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a>regress@rtme-mx-62&gt; monitor interface et-2/0/0.0   
<a id=__codelineno-7-2 name=__codelineno-7-2></a>Interface: et-2/0/0.0, Enabled, Link is Up
<a id=__codelineno-7-3 name=__codelineno-7-3></a>
<a id=__codelineno-7-4 name=__codelineno-7-4></a>&lt;- truncated output -&gt;
<a id=__codelineno-7-5 name=__codelineno-7-5></a>
<a id=__codelineno-7-6 name=__codelineno-7-6></a>Remote statistics:
<a id=__codelineno-7-7 name=__codelineno-7-7></a>  Input bytes:                 132708516 (0 bps)                           [0]
<a id=__codelineno-7-8 name=__codelineno-7-8></a>  Output bytes:              49128737556 (3921056 bps)                     [0]
<a id=__codelineno-7-9 name=__codelineno-7-9></a>  Input packets:                  270844 (0 pps)                           [0]
<a id=__codelineno-7-10 name=__codelineno-7-10></a>  Output packets:              100262735 (1000 pps)                        [0] &lt;&lt;&lt; Only Customer A traffic
</code></pre></div></td></tr></table></div> <p>The <strong>FBF filter</strong> is functioning as expected. Only <strong>Customer A</strong> traffic continues to follow the default best path toward <strong>8.8.8.0/24</strong> via the PNI interface.</p> <p>Next, we check the statistics on the <strong>core-facing interfaces</strong> to confirm that <strong>Customer B</strong> traffic is being properly redirected through the <strong>SR/MPLS tunnel</strong> as intended by the FBF configuration:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-1> 1</a></span>
<span class=normal><a href=#__codelineno-8-2> 2</a></span>
<span class=normal><a href=#__codelineno-8-3> 3</a></span>
<span class=normal><a href=#__codelineno-8-4> 4</a></span>
<span class=normal><a href=#__codelineno-8-5> 5</a></span>
<span class=normal><a href=#__codelineno-8-6> 6</a></span>
<span class=normal><a href=#__codelineno-8-7> 7</a></span>
<span class=normal><a href=#__codelineno-8-8> 8</a></span>
<span class=normal><a href=#__codelineno-8-9> 9</a></span>
<span class=normal><a href=#__codelineno-8-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a>regress@rtme-mx-62&gt; monitor interface et-5/0/0.0  
<a id=__codelineno-8-2 name=__codelineno-8-2></a>Interface: et-5/0/0.0, Enabled, Link is Up
<a id=__codelineno-8-3 name=__codelineno-8-3></a>
<a id=__codelineno-8-4 name=__codelineno-8-4></a>&lt;- truncated output -&gt;
<a id=__codelineno-8-5 name=__codelineno-8-5></a>
<a id=__codelineno-8-6 name=__codelineno-8-6></a>Remote statistics:
<a id=__codelineno-8-7 name=__codelineno-8-7></a>  Input bytes:                 253750639 (584 bps)                         [0]
<a id=__codelineno-8-8 name=__codelineno-8-8></a>  Output bytes:              57241664165 (19600072 bps)                    [0]
<a id=__codelineno-8-9 name=__codelineno-8-9></a>  Input packets:                  533880 (1 pps)                           [0]
<a id=__codelineno-8-10 name=__codelineno-8-10></a>  Output packets:              116839924 (5000 pps)                        [0] &lt;&lt;&lt; the tunneled Customer B traffic 
</code></pre></div></td></tr></table></div> <p>Everything looks good! To demonstrate that there is no fallback mechanism with <strong>next-ip</strong>-based FBF, we'll remove the <strong>loopback (192.168.1.1/32)</strong> announcement from the ASBR. As a result, the <strong>DUT</strong> will no longer have a route to the loopback, and the traffic will be dropped:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a>regress@rtme-mx-62&gt; show route 192.168.1.1 table VRF1.inet   
</code></pre></div></td></tr></table></div> <p>This means that traffic from <strong>Customer B</strong> should be dropped, which is exactly what we observe. As shown below, there is no longer any traffic on the <strong>Core interface</strong>, and <strong>Customer A</strong> traffic continues to flow through the <strong>PNI port</strong>.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a>regress@rtme-mx-62&gt; monitor interface et-5/0/0.0  
<a id=__codelineno-10-2 name=__codelineno-10-2></a>Interface: et-5/0/0.0, Enabled, Link is Up
<a id=__codelineno-10-3 name=__codelineno-10-3></a>
<a id=__codelineno-10-4 name=__codelineno-10-4></a>&lt;- truncated output -&gt;
<a id=__codelineno-10-5 name=__codelineno-10-5></a>
<a id=__codelineno-10-6 name=__codelineno-10-6></a>Remote statistics:
<a id=__codelineno-10-7 name=__codelineno-10-7></a>  Input bytes:                 253763429 (248 bps)                         [0]
<a id=__codelineno-10-8 name=__codelineno-10-8></a>  Output bytes:              58533097602 (0 bps)                          [57]
<a id=__codelineno-10-9 name=__codelineno-10-9></a>  Input packets:                  534091 (0 pps)                           [0]
<a id=__codelineno-10-10 name=__codelineno-10-10></a>  Output packets:              119475689 (0 pps)                           [1] &lt;&lt;&lt; Customer B traffic dropped
<a id=__codelineno-10-11 name=__codelineno-10-11></a>
<a id=__codelineno-10-12 name=__codelineno-10-12></a>monitor interface et-2/0/0.0 
<a id=__codelineno-10-13 name=__codelineno-10-13></a>Interface: et-2/0/0.0, Enabled, Link is Up
<a id=__codelineno-10-14 name=__codelineno-10-14></a>
<a id=__codelineno-10-15 name=__codelineno-10-15></a>&lt;- truncated output -&gt;
<a id=__codelineno-10-16 name=__codelineno-10-16></a>
<a id=__codelineno-10-17 name=__codelineno-10-17></a>Remote statistics:
<a id=__codelineno-10-18 name=__codelineno-10-18></a>  Input bytes:                 132708516 (296 bps)                         [0]
<a id=__codelineno-10-19 name=__codelineno-10-19></a>  Output bytes:              49685006066 (3921096 bps)                     [0]
<a id=__codelineno-10-20 name=__codelineno-10-20></a>  Input packets:                  270844 (0 pps)                           [0]
<a id=__codelineno-10-21 name=__codelineno-10-21></a>  Output packets:              101397976 (1000 pps)                        [0] &lt;&lt;&lt; Customer A still forwarded
</code></pre></div></td></tr></table></div> <p>As discussed earlier, the default action when next-ip address becomes unreachable is to redirect traffic to the reject next-hop. Above, we issue a show route of the next-ip address and nothing was return as expected. Just now issue the show route forwarding-table:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-11-1>1</a></span>
<span class=normal><a href=#__codelineno-11-2>2</a></span>
<span class=normal><a href=#__codelineno-11-3>3</a></span>
<span class=normal><a href=#__codelineno-11-4>4</a></span>
<span class=normal><a href=#__codelineno-11-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a>regress@rtme-mx-62&gt; show route forwarding-table destination 192.168.1.1 table VRF1    
<a id=__codelineno-11-2 name=__codelineno-11-2></a>Routing table: VRF1.inet
<a id=__codelineno-11-3 name=__codelineno-11-3></a>Internet:
<a id=__codelineno-11-4 name=__codelineno-11-4></a>Destination        Type RtRef Next hop           Type Index    NhRef Netif
<a id=__codelineno-11-5 name=__codelineno-11-5></a>default            perm     0                    rjct      695     1       &lt;&lt;&lt; rjct = reject next-hop
</code></pre></div></td></tr></table></div> <p>The route points to reject next-hop in the FIB. As said, the next-hop will punted the packets to the RE for further processing (ICMP unreachable). As also mentioned those punted packet are rate-limited by the ASIC to 2kpps. We can verify this behavior, by checking the DDOS protection statistics for the "reject" protocol:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-12-1>1</a></span>
<span class=normal><a href=#__codelineno-12-2>2</a></span>
<span class=normal><a href=#__codelineno-12-3>3</a></span>
<span class=normal><a href=#__codelineno-12-4>4</a></span>
<span class=normal><a href=#__codelineno-12-5>5</a></span>
<span class=normal><a href=#__codelineno-12-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a>regress@rtme-mx-62&gt; show ddos-protection protocols reject statistics terse 
<a id=__codelineno-12-2 name=__codelineno-12-2></a>Packet types: 1, Received traffic: 1, Currently violated: 1
<a id=__codelineno-12-3 name=__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4></a>Protocol    Packet      Received        Dropped        Rate     Violation State
<a id=__codelineno-12-5 name=__codelineno-12-5></a>group       type        (packets)       (packets)      (pps)    counts
<a id=__codelineno-12-6 name=__codelineno-12-6></a>reject      aggregate   6396663340756   6395549305435  5000     9         viol 
</code></pre></div></td></tr></table></div> <p>We saw our 5K of Customer B traffic before being rate-limited. Issue the "violation" check command to see the rate-limit value of 2K pps: </p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-13-1>1</a></span>
<span class=normal><a href=#__codelineno-13-2>2</a></span>
<span class=normal><a href=#__codelineno-13-3>3</a></span>
<span class=normal><a href=#__codelineno-13-4>4</a></span>
<span class=normal><a href=#__codelineno-13-5>5</a></span>
<span class=normal><a href=#__codelineno-13-6>6</a></span>
<span class=normal><a href=#__codelineno-13-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a>regress@rtme-mx-62&gt; show ddos-protection protocols violations 
<a id=__codelineno-13-2 name=__codelineno-13-2></a>Packet types: 255, Currently violated: 1
<a id=__codelineno-13-3 name=__codelineno-13-3></a>
<a id=__codelineno-13-4 name=__codelineno-13-4></a>Protocol    Packet      Bandwidth  Arrival   Peak      Policer bandwidth
<a id=__codelineno-13-5 name=__codelineno-13-5></a>group       type        (pps)      rate(pps) rate(pps) violation detected at
<a id=__codelineno-13-6 name=__codelineno-13-6></a>reject      aggregate   2000       5000      11682678  2025-04-10 08:22:39 PDT  &lt;&lt;&lt; Bandwidth = rate-limit = 2k pps
<a id=__codelineno-13-7 name=__codelineno-13-7></a>          Detected on: FPC-5
</code></pre></div></td></tr></table></div> <p>So it means our RE will received a maximum of 2K rejected packets and will generate 2K ICMP unreachable packets in reply. Just check our port connected to the IP Fabric and oh ! Suprise 2Kpps in output. These are our ICMP unreachable sent out back to the Customer B.</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-14-1> 1</a></span>
<span class=normal><a href=#__codelineno-14-2> 2</a></span>
<span class=normal><a href=#__codelineno-14-3> 3</a></span>
<span class=normal><a href=#__codelineno-14-4> 4</a></span>
<span class=normal><a href=#__codelineno-14-5> 5</a></span>
<span class=normal><a href=#__codelineno-14-6> 6</a></span>
<span class=normal><a href=#__codelineno-14-7> 7</a></span>
<span class=normal><a href=#__codelineno-14-8> 8</a></span>
<span class=normal><a href=#__codelineno-14-9> 9</a></span>
<span class=normal><a href=#__codelineno-14-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a>regress@rtme-mx-62&gt; monitor interface et-2/0/0.0   
<a id=__codelineno-14-2 name=__codelineno-14-2></a>Interface: et-2/0/0.0, Enabled, Link is Up
<a id=__codelineno-14-3 name=__codelineno-14-3></a>
<a id=__codelineno-14-4 name=__codelineno-14-4></a>&lt;- truncated output -&gt;
<a id=__codelineno-14-5 name=__codelineno-14-5></a>
<a id=__codelineno-14-6 name=__codelineno-14-6></a>Remote statistics:
<a id=__codelineno-14-7 name=__codelineno-14-7></a>  Input bytes:              117022326356 (23519664 bps)             [11197970]
<a id=__codelineno-14-8 name=__codelineno-14-8></a>  Output bytes:                178738122 (895984 bps)                 [426496]
<a id=__codelineno-14-9 name=__codelineno-14-9></a>  Input packets:               238821075 (6000 pps)                    [22853]
<a id=__codelineno-14-10 name=__codelineno-14-10></a>  Output packets:                3191752 (2000 pps)                     [7616] &lt;&lt;&lt; 2K ICMP Unreachable targeting Cust. B
</code></pre></div></td></tr></table></div> <p><strong>How we can avoid that?</strong> </p> <p>The easiest solution is to have in your FIB always a last resort route entry, that could be discard but why not a fallback path to route the next-ip address. In our case, if 192.168.1.1 deaseappers, we may want:</p> <ul> <li>to not reject/discard the traffic but move back to the PNI interface. For that we need to configure a static route pointing to PNI peer, with a higher preference as a backup path for 192.168.1.1. Let's do simply add this static route in our VRF and check just after the commit the statistics of our PNI interface to see if all our 6K pps (A+B traffic) are forwarded back:</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-15-1> 1</a></span>
<span class=normal><a href=#__codelineno-15-2> 2</a></span>
<span class=normal><a href=#__codelineno-15-3> 3</a></span>
<span class=normal><a href=#__codelineno-15-4> 4</a></span>
<span class=normal><a href=#__codelineno-15-5> 5</a></span>
<span class=normal><a href=#__codelineno-15-6> 6</a></span>
<span class=normal><a href=#__codelineno-15-7> 7</a></span>
<span class=normal><a href=#__codelineno-15-8> 8</a></span>
<span class=normal><a href=#__codelineno-15-9> 9</a></span>
<span class=normal><a href=#__codelineno-15-10>10</a></span>
<span class=normal><a href=#__codelineno-15-11>11</a></span>
<span class=normal><a href=#__codelineno-15-12>12</a></span>
<span class=normal><a href=#__codelineno-15-13>13</a></span>
<span class=normal><a href=#__codelineno-15-14>14</a></span>
<span class=normal><a href=#__codelineno-15-15>15</a></span>
<span class=normal><a href=#__codelineno-15-16>16</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a>edit private
<a id=__codelineno-15-2 name=__codelineno-15-2></a>
<a id=__codelineno-15-3 name=__codelineno-15-3></a>set routing-instances VRF1 routing-options static route 192.168.1.1/32 next-hop 172.16.8.1 preference 254
<a id=__codelineno-15-4 name=__codelineno-15-4></a>
<a id=__codelineno-15-5 name=__codelineno-15-5></a>commit comment "ADD_BACKUP_NEXT_IP" and-quit
<a id=__codelineno-15-6 name=__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7></a>regress@rtme-mx-62&gt; monitor interface et-2/0/0.0   
<a id=__codelineno-15-8 name=__codelineno-15-8></a>Interface: et-2/0/0.0, Enabled, Link is Up
<a id=__codelineno-15-9 name=__codelineno-15-9></a>
<a id=__codelineno-15-10 name=__codelineno-15-10></a>&lt;- truncated output -&gt;
<a id=__codelineno-15-11 name=__codelineno-15-11></a>
<a id=__codelineno-15-12 name=__codelineno-15-12></a>Remote statistics:
<a id=__codelineno-15-13 name=__codelineno-15-13></a>  Input bytes:                 132708516 (0 bps)                           [0]
<a id=__codelineno-15-14 name=__codelineno-15-14></a>  Output bytes:              50812435866 (23522568 bps)              [5629120]
<a id=__codelineno-15-15 name=__codelineno-15-15></a>  Input packets:                  270844 (0 pps)                           [0]
<a id=__codelineno-15-16 name=__codelineno-15-16></a>  Output packets:              103698854 (6000 pps)                    [11488] &lt;&lt;&lt; We backup B traffic to PNI
</code></pre></div></td></tr></table></div> <ul> <li>or to silently discard the traffic. In this scenario we can create a static route with higher preference pointing to <strong>discard</strong> next-hop. In our case, I've just added a default discard route in the VRF. so, if 192.168.1.1/32 is not announce anymore, the lookup of the next-ip address will fall back to this default discard instead of matching the default reject. Let's remove the previous static route and add the new default one:</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-16-1>1</a></span>
<span class=normal><a href=#__codelineno-16-2>2</a></span>
<span class=normal><a href=#__codelineno-16-3>3</a></span>
<span class=normal><a href=#__codelineno-16-4>4</a></span>
<span class=normal><a href=#__codelineno-16-5>5</a></span>
<span class=normal><a href=#__codelineno-16-6>6</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a>edit private
<a id=__codelineno-16-2 name=__codelineno-16-2></a>
<a id=__codelineno-16-3 name=__codelineno-16-3></a>delete routing-instances VRF1 routing-options static route 192.168.1.1/32          
<a id=__codelineno-16-4 name=__codelineno-16-4></a>set routing-instances VRF1 routing-options static route 0.0.0.0/0 discard 
<a id=__codelineno-16-5 name=__codelineno-16-5></a>
<a id=__codelineno-16-6 name=__codelineno-16-6></a>commit comment "ADD_DEFAULT" and-quit
</code></pre></div></td></tr></table></div> <p>So, with this last configuration, our Customer B traffic should be now silently discared and we shouldn't observe DDOS protocol violation and ICMP unreachable traffic:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-17-1> 1</a></span>
<span class=normal><a href=#__codelineno-17-2> 2</a></span>
<span class=normal><a href=#__codelineno-17-3> 3</a></span>
<span class=normal><a href=#__codelineno-17-4> 4</a></span>
<span class=normal><a href=#__codelineno-17-5> 5</a></span>
<span class=normal><a href=#__codelineno-17-6> 6</a></span>
<span class=normal><a href=#__codelineno-17-7> 7</a></span>
<span class=normal><a href=#__codelineno-17-8> 8</a></span>
<span class=normal><a href=#__codelineno-17-9> 9</a></span>
<span class=normal><a href=#__codelineno-17-10>10</a></span>
<span class=normal><a href=#__codelineno-17-11>11</a></span>
<span class=normal><a href=#__codelineno-17-12>12</a></span>
<span class=normal><a href=#__codelineno-17-13>13</a></span>
<span class=normal><a href=#__codelineno-17-14>14</a></span>
<span class=normal><a href=#__codelineno-17-15>15</a></span>
<span class=normal><a href=#__codelineno-17-16>16</a></span>
<span class=normal><a href=#__codelineno-17-17>17</a></span>
<span class=normal><a href=#__codelineno-17-18>18</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a>regress@rtme-mx-62&gt; monitor interface et-2/0/0.0   
<a id=__codelineno-17-2 name=__codelineno-17-2></a>Interface: et-2/0/0.0, Enabled, Link is Up
<a id=__codelineno-17-3 name=__codelineno-17-3></a>Flags: SNMP-Traps 0x4000
<a id=__codelineno-17-4 name=__codelineno-17-4></a>Encapsulation: ENET2
<a id=__codelineno-17-5 name=__codelineno-17-5></a>Local statistics:                                                Current delta
<a id=__codelineno-17-6 name=__codelineno-17-6></a>  Input bytes:                    216186                                   [0]
<a id=__codelineno-17-7 name=__codelineno-17-7></a>  Output bytes:                   505399                                   [0]
<a id=__codelineno-17-8 name=__codelineno-17-8></a>  Input packets:                    3530                                   [0]
<a id=__codelineno-17-9 name=__codelineno-17-9></a>  Output packets:                   6274                                   [0]
<a id=__codelineno-17-10 name=__codelineno-17-10></a>Remote statistics:
<a id=__codelineno-17-11 name=__codelineno-17-11></a>  Input bytes:              119682374166 (23516136 bps)              [5628630]
<a id=__codelineno-17-12 name=__codelineno-17-12></a>  Output bytes:                230359258 (0 bps)                           [0]
<a id=__codelineno-17-13 name=__codelineno-17-13></a>  Input packets:               244249744 (5999 pps)                    [11487]
<a id=__codelineno-17-14 name=__codelineno-17-14></a>  Output packets:                4113558 (0 pps)                           [0] &lt;&lt;&lt; No more ICMP Unreach. 
<a id=__codelineno-17-15 name=__codelineno-17-15></a>
<a id=__codelineno-17-16 name=__codelineno-17-16></a>
<a id=__codelineno-17-17 name=__codelineno-17-17></a>regress@rtme-mx-62&gt; show ddos-protection protocols violations    
<a id=__codelineno-17-18 name=__codelineno-17-18></a>Packet types: 255, Currently violated: 0   &lt;&lt;&lt; No more Violation 
</code></pre></div></td></tr></table></div> <h2 id=pfe-analysis>1.4. PFE analysis<a class=headerlink href=#pfe-analysis title="Permanent link">¶</a></h2> <p>Now, let’s re-announce the <strong>192.168.1.1/32</strong> prefix and examine how the FBF filter is applied on the <strong>PFE</strong>. Begin by running the following command to access the <strong>PFE CLI</strong>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-18-1>1</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a>regress@rtme-mx-62&gt; start shell pfe network fpc5
</code></pre></div></td></tr></table></div> <p>Next, list all the filters available on the linecard:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-19-1>1</a></span>
<span class=normal><a href=#__codelineno-19-2>2</a></span>
<span class=normal><a href=#__codelineno-19-3>3</a></span>
<span class=normal><a href=#__codelineno-19-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a>root@rtme-mx-62-fpc5:pfe&gt; show firewall 
<a id=__codelineno-19-2 name=__codelineno-19-2></a>Name                                   Index          Token            Status
<a id=__codelineno-19-3 name=__codelineno-19-3></a>FBF                                    1               2875            DMEM
<a id=__codelineno-19-4 name=__codelineno-19-4></a>&lt;- truncated output -&gt;
</code></pre></div></td></tr></table></div> <p>Now resolve the token index <code>2875</code> to display the filter’s program:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-20-1> 1</a></span>
<span class=normal><a href=#__codelineno-20-2> 2</a></span>
<span class=normal><a href=#__codelineno-20-3> 3</a></span>
<span class=normal><a href=#__codelineno-20-4> 4</a></span>
<span class=normal><a href=#__codelineno-20-5> 5</a></span>
<span class=normal><a href=#__codelineno-20-6> 6</a></span>
<span class=normal><a href=#__codelineno-20-7> 7</a></span>
<span class=normal><a href=#__codelineno-20-8> 8</a></span>
<span class=normal><a href=#__codelineno-20-9> 9</a></span>
<span class=normal><a href=#__codelineno-20-10>10</a></span>
<span class=normal><a href=#__codelineno-20-11>11</a></span>
<span class=normal><a href=#__codelineno-20-12>12</a></span>
<span class=normal><a href=#__codelineno-20-13>13</a></span>
<span class=normal><a href=#__codelineno-20-14>14</a></span>
<span class=normal><a href=#__codelineno-20-15>15</a></span>
<span class=normal><a href=#__codelineno-20-16>16</a></span>
<span class=normal><a href=#__codelineno-20-17>17</a></span>
<span class=normal><a href=#__codelineno-20-18>18</a></span>
<span class=normal><a href=#__codelineno-20-19>19</a></span>
<span class=normal><a href=#__codelineno-20-20>20</a></span>
<span class=normal><a href=#__codelineno-20-21>21</a></span>
<span class=normal><a href=#__codelineno-20-22>22</a></span>
<span class=normal><a href=#__codelineno-20-23>23</a></span>
<span class=normal><a href=#__codelineno-20-24>24</a></span>
<span class=normal><a href=#__codelineno-20-25>25</a></span>
<span class=normal><a href=#__codelineno-20-26>26</a></span>
<span class=normal><a href=#__codelineno-20-27>27</a></span>
<span class=normal><a href=#__codelineno-20-28>28</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a>root@rtme-mx-62-fpc5:pfe&gt; show sandbox token 22571514 
<a id=__codelineno-20-2 name=__codelineno-20-2></a>
<a id=__codelineno-20-3 name=__codelineno-20-3></a>&lt;- truncated output -&gt;
<a id=__codelineno-20-4 name=__codelineno-20-4></a>
<a id=__codelineno-20-5 name=__codelineno-20-5></a>Filter properties: None
<a id=__codelineno-20-6 name=__codelineno-20-6></a>Filter state = CONSISTENT
<a id=__codelineno-20-7 name=__codelineno-20-7></a>term PBR_CUSTOMER_B
<a id=__codelineno-20-8 name=__codelineno-20-8></a>term priority 0
<a id=__codelineno-20-9 name=__codelineno-20-9></a>    source-address
<a id=__codelineno-20-10 name=__codelineno-20-10></a>        172.222.0/24
<a id=__codelineno-20-11 name=__codelineno-20-11></a>        false branch to match action in rule OTHER
<a id=__codelineno-20-12 name=__codelineno-20-12></a>
<a id=__codelineno-20-13 name=__codelineno-20-13></a>    then
<a id=__codelineno-20-14 name=__codelineno-20-14></a>        accept
<a id=__codelineno-20-15 name=__codelineno-20-15></a>        count CUSTOMERB
<a id=__codelineno-20-16 name=__codelineno-20-16></a>         Policy Route:
<a id=__codelineno-20-17 name=__codelineno-20-17></a>         Destination Prefix: 192.168.1.1
<a id=__codelineno-20-18 name=__codelineno-20-18></a>         Routing instance: VRF1
<a id=__codelineno-20-19 name=__codelineno-20-19></a>         Policy route action is valid: TRUE
<a id=__codelineno-20-20 name=__codelineno-20-20></a>term OTHER
<a id=__codelineno-20-21 name=__codelineno-20-21></a>term priority 0
<a id=__codelineno-20-22 name=__codelineno-20-22></a>
<a id=__codelineno-20-23 name=__codelineno-20-23></a>    then
<a id=__codelineno-20-24 name=__codelineno-20-24></a>        accept
<a id=__codelineno-20-25 name=__codelineno-20-25></a>        count OTHER
<a id=__codelineno-20-26 name=__codelineno-20-26></a>Previous nodes count: 1      
<a id=__codelineno-20-27 name=__codelineno-20-27></a>Next nodes count    : 0      
<a id=__codelineno-20-28 name=__codelineno-20-28></a>Entries count       : 0               
</code></pre></div></td></tr></table></div> <p>The above output shows the filter program optimized by the Firewall Filter compiler. To display the actual program pushed into hardware, use the following PFE commands:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-21-1>1</a></span>
<span class=normal><a href=#__codelineno-21-2>2</a></span>
<span class=normal><a href=#__codelineno-21-3>3</a></span>
<span class=normal><a href=#__codelineno-21-4>4</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a>root@rtme-mx-62-fpc5:pfe&gt; show firewall instance 
<a id=__codelineno-21-2 name=__codelineno-21-2></a>Name,Index              Instance Key                    InstanceToken           LinkCount
<a id=__codelineno-21-3 name=__codelineno-21-3></a>FBF,1                   no-next-filter-0                5424                    1
<a id=__codelineno-21-4 name=__codelineno-21-4></a>&lt;- truncated output -&gt;
</code></pre></div></td></tr></table></div> <p>Then, run this second command using the Token ID <code>5424</code>, retrieved from the previous step:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-22-1> 1</a></span>
<span class=normal><a href=#__codelineno-22-2> 2</a></span>
<span class=normal><a href=#__codelineno-22-3> 3</a></span>
<span class=normal><a href=#__codelineno-22-4> 4</a></span>
<span class=normal><a href=#__codelineno-22-5> 5</a></span>
<span class=normal><a href=#__codelineno-22-6> 6</a></span>
<span class=normal><a href=#__codelineno-22-7> 7</a></span>
<span class=normal><a href=#__codelineno-22-8> 8</a></span>
<span class=normal><a href=#__codelineno-22-9> 9</a></span>
<span class=normal><a href=#__codelineno-22-10>10</a></span>
<span class=normal><a href=#__codelineno-22-11>11</a></span>
<span class=normal><a href=#__codelineno-22-12>12</a></span>
<span class=normal><a href=#__codelineno-22-13>13</a></span>
<span class=normal><a href=#__codelineno-22-14>14</a></span>
<span class=normal><a href=#__codelineno-22-15>15</a></span>
<span class=normal><a href=#__codelineno-22-16>16</a></span>
<span class=normal><a href=#__codelineno-22-17>17</a></span>
<span class=normal><a href=#__codelineno-22-18>18</a></span>
<span class=normal><a href=#__codelineno-22-19>19</a></span>
<span class=normal><a href=#__codelineno-22-20>20</a></span>
<span class=normal><a href=#__codelineno-22-21>21</a></span>
<span class=normal><a href=#__codelineno-22-22>22</a></span>
<span class=normal><a href=#__codelineno-22-23>23</a></span>
<span class=normal><a href=#__codelineno-22-24>24</a></span>
<span class=normal><a href=#__codelineno-22-25>25</a></span>
<span class=normal><a href=#__codelineno-22-26>26</a></span>
<span class=normal><a href=#__codelineno-22-27>27</a></span>
<span class=normal><a href=#__codelineno-22-28>28</a></span>
<span class=normal><a href=#__codelineno-22-29>29</a></span>
<span class=normal><a href=#__codelineno-22-30>30</a></span>
<span class=normal><a href=#__codelineno-22-31>31</a></span>
<span class=normal><a href=#__codelineno-22-32>32</a></span>
<span class=normal><a href=#__codelineno-22-33>33</a></span>
<span class=normal><a href=#__codelineno-22-34>34</a></span>
<span class=normal><a href=#__codelineno-22-35>35</a></span>
<span class=normal><a href=#__codelineno-22-36>36</a></span>
<span class=normal><a href=#__codelineno-22-37>37</a></span>
<span class=normal><a href=#__codelineno-22-38>38</a></span>
<span class=normal><a href=#__codelineno-22-39>39</a></span>
<span class=normal><a href=#__codelineno-22-40>40</a></span>
<span class=normal><a href=#__codelineno-22-41>41</a></span>
<span class=normal><a href=#__codelineno-22-42>42</a></span>
<span class=normal><a href=#__codelineno-22-43>43</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a>root@rtme-mx-62-fpc5:pfe&gt; show sandbox token 5424 
<a id=__codelineno-22-2 name=__codelineno-22-2></a>
<a id=__codelineno-22-3 name=__codelineno-22-3></a>&lt;- truncated output -&gt;
<a id=__codelineno-22-4 name=__codelineno-22-4></a>
<a id=__codelineno-22-5 name=__codelineno-22-5></a>JNH_FW_START:
<a id=__codelineno-22-6 name=__codelineno-22-6></a>        opcode = 0x0000000c
<a id=__codelineno-22-7 name=__codelineno-22-7></a>        anonymous_union_0 = 0x00008605
<a id=__codelineno-22-8 name=__codelineno-22-8></a>        filter_id = 0x00000000
<a id=__codelineno-22-9 name=__codelineno-22-9></a>        cntr_base = 0x00000001
<a id=__codelineno-22-10 name=__codelineno-22-10></a>        flt_base = 0x00000000
<a id=__codelineno-22-11 name=__codelineno-22-11></a>        base_ptr = 0x000255af
<a id=__codelineno-22-12 name=__codelineno-22-12></a>
<a id=__codelineno-22-13 name=__codelineno-22-13></a>Filter is not interface specific 1
<a id=__codelineno-22-14 name=__codelineno-22-14></a>
<a id=__codelineno-22-15 name=__codelineno-22-15></a>Current context : 0.
<a id=__codelineno-22-16 name=__codelineno-22-16></a>
<a id=__codelineno-22-17 name=__codelineno-22-17></a>Pfe Inst:0 Hw Instance 1, type:1 op:2 ref 0
<a id=__codelineno-22-18 name=__codelineno-22-18></a>  Counter Base:- 0x5400f8
<a id=__codelineno-22-19 name=__codelineno-22-19></a>  Policer Base:- 0
<a id=__codelineno-22-20 name=__codelineno-22-20></a>  Number of counters : 2 (including PSAs)
<a id=__codelineno-22-21 name=__codelineno-22-21></a>
<a id=__codelineno-22-22 name=__codelineno-22-22></a>term PBR_CUSTOMER_B (pfe-inst 0)
<a id=__codelineno-22-23 name=__codelineno-22-23></a>     Start Addr   :- 0x8605
<a id=__codelineno-22-24 name=__codelineno-22-24></a>     Stop Addr    :- 0x8607
<a id=__codelineno-22-25 name=__codelineno-22-25></a>     Stop NH      :- 0x6808255ab012ad58
<a id=__codelineno-22-26 name=__codelineno-22-26></a>         Decoding :- FW_STOP: pdesc:0x104ab56 desc:0x4ab56
<a id=__codelineno-22-27 name=__codelineno-22-27></a>
<a id=__codelineno-22-28 name=__codelineno-22-28></a>     Action Addr  :- 0x4ab56
<a id=__codelineno-22-29 name=__codelineno-22-29></a>     Action NH    :- 0x812aed800010000
<a id=__codelineno-22-30 name=__codelineno-22-30></a>
<a id=__codelineno-22-31 name=__codelineno-22-31></a>match type: prefix
<a id=__codelineno-22-32 name=__codelineno-22-32></a>  loc: 0x8605 nh: 0x7e30004002800000
<a id=__codelineno-22-33 name=__codelineno-22-33></a>  FW_4BMATCH: fwop:0 desc:0x8005 koffset:396 boffset:0 mask:0x149c00e8 data:0x7fb7
<a id=__codelineno-22-34 name=__codelineno-22-34></a>
<a id=__codelineno-22-35 name=__codelineno-22-35></a>Inst: 0 Action-Type: 134
<a id=__codelineno-22-36 name=__codelineno-22-36></a>        JNH      :- 0x2bfffffd00000300:   &lt;&lt;&lt; count CUSTOMERB;
<a id=__codelineno-22-37 name=__codelineno-22-37></a>                 CounterNH: Relative Base = 1, Offset = 0x0, nextNH = 0xffffff
<a id=__codelineno-22-38 name=__codelineno-22-38></a>
<a id=__codelineno-22-39 name=__codelineno-22-39></a>Inst: 0 Action-Type: 0
<a id=__codelineno-22-40 name=__codelineno-22-40></a>        JNH      :- 0x201282240000000c:   &lt;&lt;&lt; next-ip 192.168.1.1/32 routing-instance VRF1;
<a id=__codelineno-22-41 name=__codelineno-22-41></a>                 UcodeNH: Indirect Decode: Indirect, Next = 0x4a089, pnh_id = 0, ,
<a id=__codelineno-22-42 name=__codelineno-22-42></a>
<a id=__codelineno-22-43 name=__codelineno-22-43></a>&lt;- truncated output -&gt;
</code></pre></div></td></tr></table></div> <p>Pick the JNH dword corresponding to the next-ip action <code>0x201282240000000c</code> (line 40), and decode it:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1>1</a></span>
<span class=normal><a href=#__codelineno-23-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x201282240000000c inst 2    
<a id=__codelineno-23-2 name=__codelineno-23-2></a>UcodeNH: Indirect Decode: Indirect, Next = 0x4a089, pnh_id = 0,
</code></pre></div></td></tr></table></div> <p><strong>UcodeNH</strong> will run a micro-code sequence. Here, it is an indirection to a virtual address found in the <strong>Next</strong> field. To read the data at <code>0x4a089</code>, run:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-1>1</a></span>
<span class=normal><a href=#__codelineno-24-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh vread vaddr 0x4a089 NH inst 2            
<a id=__codelineno-24-2 name=__codelineno-24-2></a>Addr:Nexthop 0x4a089 Paddr:0x104a089, Data = 0x0812659400040000
</code></pre></div></td></tr></table></div> <p>This returns two key values:</p> <ul> <li><strong>Paddr</strong> (physical address): <code>0x104a089</code></li> <li><strong>Data</strong> read: <code>0x0812659400040000</code></li> </ul> <blockquote> <p>Note: To read a physical address, use <code>show pread paddr xxx</code>.</p> </blockquote> <p>Since the value is a JNH word, decode it again. This time it reveals a <strong>CallNH</strong>, a list of ordered next-hops (when <strong>mode=0</strong>):</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-25-1>1</a></span>
<span class=normal><a href=#__codelineno-25-2>2</a></span>
<span class=normal><a href=#__codelineno-25-3>3</a></span>
<span class=normal><a href=#__codelineno-25-4>4</a></span>
<span class=normal><a href=#__codelineno-25-5>5</a></span>
<span class=normal><a href=#__codelineno-25-6>6</a></span>
<span class=normal><a href=#__codelineno-25-7>7</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x0812659400040000 inst 2 
<a id=__codelineno-25-2 name=__codelineno-25-2></a>CallNH:desc_ptr:0x49965, mode=0, count=0x5
<a id=__codelineno-25-3 name=__codelineno-25-3></a>  0x049960  0 : 0x168c000000000000
<a id=__codelineno-25-4 name=__codelineno-25-4></a>  0x049961  1 : 0x40101ffffff81510
<a id=__codelineno-25-5 name=__codelineno-25-5></a>  0x049962  2 : 0x40181fffffe02030
<a id=__codelineno-25-6 name=__codelineno-25-6></a>  0x049963  3 : 0x1810318200200008
<a id=__codelineno-25-7 name=__codelineno-25-7></a>  0x049964  4 : 0x23fffffc00000001 &lt;&lt;&lt; this one will be skipped - related to fabric encap.
</code></pre></div></td></tr></table></div> <p>Now decode each action (excluding the fifth one, which is outside the scope of this article):</p> <ul> <li>The first is a <code>ModifyNH</code>, which modifies local memory — in this case, resetting the encapsulation length:</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-1>1</a></span>
<span class=normal><a href=#__codelineno-26-2>2</a></span>
<span class=normal><a href=#__codelineno-26-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x168c000000000000 inst 2    
<a id=__codelineno-26-2 name=__codelineno-26-2></a>ModifyNH: Subcode=Misc(26)
<a id=__codelineno-26-3 name=__codelineno-26-3></a>(Reset encap len)
</code></pre></div></td></tr></table></div> <ul> <li>The second and third entries are <strong>BitOpNH</strong> actions, performing operations on specific data:</li> </ul> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-1>1</a></span>
<span class=normal><a href=#__codelineno-27-2>2</a></span>
<span class=normal><a href=#__codelineno-27-3>3</a></span>
<span class=normal><a href=#__codelineno-27-4>4</a></span>
<span class=normal><a href=#__codelineno-27-5>5</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x40101ffffff81510 inst 2    
<a id=__codelineno-27-2 name=__codelineno-27-2></a>BitOpNH: opcode=0x00000008, data32=0, desc_ptr=0xffffff, key=0x4/0 PPPoE Session ID, op=0, data=49320, nbits=16
<a id=__codelineno-27-3 name=__codelineno-27-3></a>
<a id=__codelineno-27-4 name=__codelineno-27-4></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x40181fffffe02030 inst 2    
<a id=__codelineno-27-5 name=__codelineno-27-5></a>BitOpNH: opcode=0x00000008, data32=0, desc_ptr=0xffffff, key=0x6/0 Unknown, op=0, data=257, nbits=16
</code></pre></div></td></tr></table></div> <p>These actions extract the next-ip address from local memory in two steps:</p> <ul> <li>First, we fetch <code>49320</code> (0xC0A8 = 192.168)</li> <li>Then, we fetch <code>257</code> (0x0101 = 1.1)</li> </ul> <p>Combined, we recover the next-ip address from our FBF filter: <strong>192.168.1.1</strong>. This is a "key" that will be used for further processing (route lookup).</p> <ul> <li>The fourth NH in the list <code>0x1810318200200008</code> is a <strong>KTREE</strong> structure used for route lookup:</li> </ul> <blockquote> <p>A <strong>KTREE</strong> is Juniper’s implementation of a binary structure known as a <strong>Patricia Tree</strong>.</p> </blockquote> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-28-1>1</a></span>
<span class=normal><a href=#__codelineno-28-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x1810318200200008 inst 2    
<a id=__codelineno-28-2 name=__codelineno-28-2></a>KtreeNH: skip=8, sw_token=0, arOffset=0, mode=1, descPtr=0xc60800, key=0x4/0 LookupKey
</code></pre></div></td></tr></table></div> <p>To dump the full KTREE, use:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-1> 1</a></span>
<span class=normal><a href=#__codelineno-29-2> 2</a></span>
<span class=normal><a href=#__codelineno-29-3> 3</a></span>
<span class=normal><a href=#__codelineno-29-4> 4</a></span>
<span class=normal><a href=#__codelineno-29-5> 5</a></span>
<span class=normal><a href=#__codelineno-29-6> 6</a></span>
<span class=normal><a href=#__codelineno-29-7> 7</a></span>
<span class=normal><a href=#__codelineno-29-8> 8</a></span>
<span class=normal><a href=#__codelineno-29-9> 9</a></span>
<span class=normal><a href=#__codelineno-29-10>10</a></span>
<span class=normal><a href=#__codelineno-29-11>11</a></span>
<span class=normal><a href=#__codelineno-29-12>12</a></span>
<span class=normal><a href=#__codelineno-29-13>13</a></span>
<span class=normal><a href=#__codelineno-29-14>14</a></span>
<span class=normal><a href=#__codelineno-29-15>15</a></span>
<span class=normal><a href=#__codelineno-29-16>16</a></span>
<span class=normal><a href=#__codelineno-29-17>17</a></span>
<span class=normal><a href=#__codelineno-29-18>18</a></span>
<span class=normal><a href=#__codelineno-29-19>19</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x1810318200200008 inst 2 ktree yes dump yes 
<a id=__codelineno-29-2 name=__codelineno-29-2></a>Route                                 Depth   JNH
<a id=__codelineno-29-3 name=__codelineno-29-3></a>------------------------------------  ------  ------------------
<a id=__codelineno-29-4 name=__codelineno-29-4></a>Default                                    0  0x0812ad6000000000
<a id=__codelineno-29-5 name=__codelineno-29-5></a>00000000/32                                1  0x0812a08400000000
<a id=__codelineno-29-6 name=__codelineno-29-6></a>080808/24                                  1  0x08129d0400000000
<a id=__codelineno-29-7 name=__codelineno-29-7></a>acde00/24                                  2  0x08129df400000000
<a id=__codelineno-29-8 name=__codelineno-29-8></a>ac6f00/24                                  2  0x08129df400000000
<a id=__codelineno-29-9 name=__codelineno-29-9></a>ac100800/31                                3  0x000000000004ab3c
<a id=__codelineno-29-10 name=__codelineno-29-10></a>ac100801/32                                4  0x0812ade000000000
<a id=__codelineno-29-11 name=__codelineno-29-11></a>ac100800/32                                4  0x0812ac9800010000
<a id=__codelineno-29-12 name=__codelineno-29-12></a>ac100004/31                                3  0x000000000004abc0
<a id=__codelineno-29-13 name=__codelineno-29-13></a>ac100005/32                                4  0x08129d4800000000
<a id=__codelineno-29-14 name=__codelineno-29-14></a>ac100004/32                                4  0x0812aec800010000
<a id=__codelineno-29-15 name=__codelineno-29-15></a>c0a80101/32                                1  0x08129a1800000000 &lt;&lt;&lt; 192.168.1.1/32
<a id=__codelineno-29-16 name=__codelineno-29-16></a>e0000001/32                                1  0x0812a0c400000000
<a id=__codelineno-29-17 name=__codelineno-29-17></a>ffffffff/32                                1  0x0812a0e400000000
<a id=__codelineno-29-18 name=__codelineno-29-18></a>
<a id=__codelineno-29-19 name=__codelineno-29-19></a>Routes found: 14, Bytes used: 6664
</code></pre></div></td></tr></table></div> <p>This KTREE acts as the FIB for our <strong>VRF1</strong> instance. For instance, traffic hitting the <strong>192.168.1.1/32</strong> prefix is redirected to the action identified by the JNH word <code>0x08129a1800000000</code>, pointing to a <strong>CallNH</strong>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-1>1</a></span>
<span class=normal><a href=#__codelineno-30-2>2</a></span>
<span class=normal><a href=#__codelineno-30-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x08129a1800000000 inst 2    
<a id=__codelineno-30-2 name=__codelineno-30-2></a>CallNH:desc_ptr:0x4a686, mode=0, count=0x1
<a id=__codelineno-30-3 name=__codelineno-30-3></a>  0x04a685  0 : 0x20129af00000000c
</code></pre></div></td></tr></table></div> <p>This value (<code>0x20129af00000000c</code>) is another <strong>UcodeNH</strong> indirection:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-31-1>1</a></span>
<span class=normal><a href=#__codelineno-31-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x20129af00000000c inst 2    
<a id=__codelineno-31-2 name=__codelineno-31-2></a>UcodeNH: Indirect Decode: Indirect, Next = 0x4a6bc, pnh_id = 0, ,
</code></pre></div></td></tr></table></div> <p>To follow the indirection, read the next-hop at <code>0x4a6bc</code>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-32-1>1</a></span>
<span class=normal><a href=#__codelineno-32-2>2</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh vread vaddr 0x4a6bc NH inst 2            
<a id=__codelineno-32-2 name=__codelineno-32-2></a>Addr:Nexthop 0x4a6bc Paddr:0x104a6bc, Data = 0x08129ad400000000
</code></pre></div></td></tr></table></div> <p>Once again, decode the JNH word retrieved from the virtual memory address — it points to another <strong>CallNH</strong> list:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-33-1>1</a></span>
<span class=normal><a href=#__codelineno-33-2>2</a></span>
<span class=normal><a href=#__codelineno-33-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x08129ad400000000 inst 2    
<a id=__codelineno-33-2 name=__codelineno-33-2></a>CallNH:desc_ptr:0x4a6b5, mode=0, count=0x1
<a id=__codelineno-33-3 name=__codelineno-33-3></a>  0x04a6b4  0 : 0x11c0000000026c14
</code></pre></div></td></tr></table></div> <p>Decode the final NH word <code>0x11c0000000026c14</code>:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-1>1</a></span>
<span class=normal><a href=#__codelineno-34-2>2</a></span>
<span class=normal><a href=#__codelineno-34-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1></a>root@rtme-mx-62-fpc5:pfe&gt; show jnh decode word 0x11c0000000026c14 inst 2    
<a id=__codelineno-34-2 name=__codelineno-34-2></a>ModifyNH: Subcode=SetNH-Token(7),Desc=0x0,Data=0x26c14,NextNH=0
<a id=__codelineno-34-3 name=__codelineno-34-3></a> (pfeDest:20, TokenIdMode:0/  , VC memberId:0, isReass:0, token:0x26c/620)
</code></pre></div></td></tr></table></div> <p>We’ve reached the final forwarding action — setting the forwarding NH index via the <strong>NH Token</strong>. Here, the token <code>0x26c</code> corresponds to the NH ID from our route lookup.</p> <p>To get more info on this next-hop:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-35-1>1</a></span>
<span class=normal><a href=#__codelineno-35-2>2</a></span>
<span class=normal><a href=#__codelineno-35-3>3</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1></a>root@rtme-mx-62-fpc5:pfe&gt; show nh db index 0x26c                                   
<a id=__codelineno-35-2 name=__codelineno-35-2></a>Index          Type        Func-Type    Proto        Nh-Flags        Ifl-Name        Ifl-Index       Nh-Token        Nh-Prefix
<a id=__codelineno-35-3 name=__codelineno-35-3></a>620            Unicast     -            ipv4_tag     0x41            et-5/0/0.0      356             5519           ac100101/32                                   
</code></pre></div></td></tr></table></div> <p>Perfect — this confirms that the traffic is forwarded via the correct path: our core-facing interface <code>et-5/0/0.0</code> and doesn't follow anymore the "best path".</p> <p>To go further (e.g., check Layer 2 headers or MPLS encapsulation), use:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-36-1> 1</a></span>
<span class=normal><a href=#__codelineno-36-2> 2</a></span>
<span class=normal><a href=#__codelineno-36-3> 3</a></span>
<span class=normal><a href=#__codelineno-36-4> 4</a></span>
<span class=normal><a href=#__codelineno-36-5> 5</a></span>
<span class=normal><a href=#__codelineno-36-6> 6</a></span>
<span class=normal><a href=#__codelineno-36-7> 7</a></span>
<span class=normal><a href=#__codelineno-36-8> 8</a></span>
<span class=normal><a href=#__codelineno-36-9> 9</a></span>
<span class=normal><a href=#__codelineno-36-10>10</a></span>
<span class=normal><a href=#__codelineno-36-11>11</a></span>
<span class=normal><a href=#__codelineno-36-12>12</a></span>
<span class=normal><a href=#__codelineno-36-13>13</a></span>
<span class=normal><a href=#__codelineno-36-14>14</a></span>
<span class=normal><a href=#__codelineno-36-15>15</a></span>
<span class=normal><a href=#__codelineno-36-16>16</a></span>
<span class=normal><a href=#__codelineno-36-17>17</a></span>
<span class=normal><a href=#__codelineno-36-18>18</a></span>
<span class=normal><a href=#__codelineno-36-19>19</a></span>
<span class=normal><a href=#__codelineno-36-20>20</a></span>
<span class=normal><a href=#__codelineno-36-21>21</a></span>
<span class=normal><a href=#__codelineno-36-22>22</a></span>
<span class=normal><a href=#__codelineno-36-23>23</a></span>
<span class=normal><a href=#__codelineno-36-24>24</a></span>
<span class=normal><a href=#__codelineno-36-25>25</a></span>
<span class=normal><a href=#__codelineno-36-26>26</a></span>
<span class=normal><a href=#__codelineno-36-27>27</a></span>
<span class=normal><a href=#__codelineno-36-28>28</a></span>
<span class=normal><a href=#__codelineno-36-29>29</a></span>
<span class=normal><a href=#__codelineno-36-30>30</a></span>
<span class=normal><a href=#__codelineno-36-31>31</a></span>
<span class=normal><a href=#__codelineno-36-32>32</a></span>
<span class=normal><a href=#__codelineno-36-33>33</a></span>
<span class=normal><a href=#__codelineno-36-34>34</a></span>
<span class=normal><a href=#__codelineno-36-35>35</a></span>
<span class=normal><a href=#__codelineno-36-36>36</a></span>
<span class=normal><a href=#__codelineno-36-37>37</a></span>
<span class=normal><a href=#__codelineno-36-38>38</a></span>
<span class=normal><a href=#__codelineno-36-39>39</a></span>
<span class=normal><a href=#__codelineno-36-40>40</a></span>
<span class=normal><a href=#__codelineno-36-41>41</a></span>
<span class=normal><a href=#__codelineno-36-42>42</a></span>
<span class=normal><a href=#__codelineno-36-43>43</a></span>
<span class=normal><a href=#__codelineno-36-44>44</a></span>
<span class=normal><a href=#__codelineno-36-45>45</a></span>
<span class=normal><a href=#__codelineno-36-46>46</a></span>
<span class=normal><a href=#__codelineno-36-47>47</a></span>
<span class=normal><a href=#__codelineno-36-48>48</a></span>
<span class=normal><a href=#__codelineno-36-49>49</a></span>
<span class=normal><a href=#__codelineno-36-50>50</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1></a>root@rtme-mx-62-fpc5:pfe&gt; show nh detail index 0x26c     
<a id=__codelineno-36-2 name=__codelineno-36-2></a>Nexthop Info:
<a id=__codelineno-36-3 name=__codelineno-36-3></a>
<a id=__codelineno-36-4 name=__codelineno-36-4></a>NH Index                      : 620
<a id=__codelineno-36-5 name=__codelineno-36-5></a>NH Type                       : Unicast
<a id=__codelineno-36-6 name=__codelineno-36-6></a>NH Proto                      : ipv4_tag
<a id=__codelineno-36-7 name=__codelineno-36-7></a>NH Flags                      : 0x41
<a id=__codelineno-36-8 name=__codelineno-36-8></a>IF Name                       : et-5/0/0.0
<a id=__codelineno-36-9 name=__codelineno-36-9></a>Prefix                        : ac100101/32
<a id=__codelineno-36-10 name=__codelineno-36-10></a>NH Token Id                   : 5519
<a id=__codelineno-36-11 name=__codelineno-36-11></a>NH Route Table Id             : 0
<a id=__codelineno-36-12 name=__codelineno-36-12></a>Sgid                          : 0
<a id=__codelineno-36-13 name=__codelineno-36-13></a>
<a id=__codelineno-36-14 name=__codelineno-36-14></a>OIF Index                     : 356
<a id=__codelineno-36-15 name=__codelineno-36-15></a>Underlying IFL                : .local..0 (0)
<a id=__codelineno-36-16 name=__codelineno-36-16></a>Session Id                    : 788
<a id=__codelineno-36-17 name=__codelineno-36-17></a>Num Tags                      : 2
<a id=__codelineno-36-18 name=__codelineno-36-18></a>Label                         : 0x4e87eff0 (20103)lbFlags: 0
<a id=__codelineno-36-19 name=__codelineno-36-19></a>Label                         : 0x10fff000 (16)lbFlags: 0
<a id=__codelineno-36-20 name=__codelineno-36-20></a>MTU                           : 0
<a id=__codelineno-36-21 name=__codelineno-36-21></a>L2 Length                     : 12
<a id=__codelineno-36-22 name=__codelineno-36-22></a>L2 Data                       : 00:00:01:64:80:00:a8:d0:e5:ef:6a:87
<a id=__codelineno-36-23 name=__codelineno-36-23></a>Filter Index                  : 0
<a id=__codelineno-36-24 name=__codelineno-36-24></a>
<a id=__codelineno-36-25 name=__codelineno-36-25></a>Platform Info
<a id=__codelineno-36-26 name=__codelineno-36-26></a>-------------
<a id=__codelineno-36-27 name=__codelineno-36-27></a>  FabricToken: 5527
<a id=__codelineno-36-28 name=__codelineno-36-28></a>  EgressToken: 5526
<a id=__codelineno-36-29 name=__codelineno-36-29></a>  IngressFeatures:
<a id=__codelineno-36-30 name=__codelineno-36-30></a>
<a id=__codelineno-36-31 name=__codelineno-36-31></a>Container token: 5519
<a id=__codelineno-36-32 name=__codelineno-36-32></a>#5 SetNhToken tokens:
<a id=__codelineno-36-33 name=__codelineno-36-33></a> Mask : 0x0
<a id=__codelineno-36-34 name=__codelineno-36-34></a> [  SetNhToken:5518  ]
<a id=__codelineno-36-35 name=__codelineno-36-35></a>
<a id=__codelineno-36-36 name=__codelineno-36-36></a>  EgressFeatures:
<a id=__codelineno-36-37 name=__codelineno-36-37></a>
<a id=__codelineno-36-38 name=__codelineno-36-38></a>Container token: 5526
<a id=__codelineno-36-39 name=__codelineno-36-39></a>#2 PushLabels tokens:
<a id=__codelineno-36-40 name=__codelineno-36-40></a> Mask : 0x0
<a id=__codelineno-36-41 name=__codelineno-36-41></a> [  PushLabels:5522  Token-1:5520  Token-2:5521  ]
<a id=__codelineno-36-42 name=__codelineno-36-42></a>#4 StatsCounter tokens:
<a id=__codelineno-36-43 name=__codelineno-36-43></a> Mask : 0x1
<a id=__codelineno-36-44 name=__codelineno-36-44></a> [  StatsCounter:5523  ]
<a id=__codelineno-36-45 name=__codelineno-36-45></a>#11 UcastEncap tokens:
<a id=__codelineno-36-46 name=__codelineno-36-46></a> Mask : 0x0
<a id=__codelineno-36-47 name=__codelineno-36-47></a> [  UcastEncap:5524  ]
<a id=__codelineno-36-48 name=__codelineno-36-48></a>#12 SetOIF tokens:
<a id=__codelineno-36-49 name=__codelineno-36-49></a> Mask : 0x0
<a id=__codelineno-36-50 name=__codelineno-36-50></a> [  SetOIF:5525  ]
</code></pre></div></td></tr></table></div> <p>The figure below summarizes our packet walkthrough and highlights the main FBF steps:</p> <p><figure><img alt="FBF next-ip at PFE level" src=../images/PFE-FBF-1.png><figcaption>Figure 3: FBF next-ip at PFE level</figcaption></figure></p> <p><strong>And that wraps up part one.</strong> Take a break — in part two, we’ll dive into configuring FBF thanks to the <strong>rib-group</strong> feature.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../chapter1/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Introduction"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Introduction </div> </div> </a> <a href=../chapter3/ class="md-footer__link md-footer__link--next" aria-label="Next: FBF use Case 2"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> FBF use Case 2 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> This site is maintained by HPE/Juniper Networking employees. Powered by Material for MkDocs & Pandoc </div> </div> <div class=md-social> <a href=https://www.linkedin.com/company/juniper-networks target=_blank rel=noopener title=www.linkedin.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5m282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> <a href=https://github.com/juniper target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["toc.follow", "navigation.top", "navigation.tabs", "navigation.instant", "navigation.footer", "navigation.indexes", "search.suggest", "content.code.annotate", "content.code.copy", "content.code.select", "content.action.edit", "content.tooltips", "content.footnote.tooltips"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.c8b220af.min.js></script> <script src=https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script> <script src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js></script> <script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js></script> <script src=../../js/math-render.js></script> <script src=../../js/extra.js></script> </body> </html>